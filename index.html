<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النسر جروب - إدارة المصنع (نسخة خاصة)</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; color-adjust: exact; }
            #invoice-preview-modal { position: static; background: white; padding: 0; display: block !important; }
            #invoice-paper { box-shadow: none; border: none; width: 210mm; max-width: none; margin: 0 auto; padding: 12mm; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #e5e7eb; padding: 6px; }
            .ph { display: none; }
            tr, td, th { page-break-inside: avoid; }
            .text-slate-800, .text-slate-900, .text-emerald-600 { color: inherit; }
        }

        @page { size: A4 portrait; margin: 10mm; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex no-print shadow-xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                <img src="100.png" alt="لوغو" class="w-8 h-8 object-contain rounded"> النسر جروب
            </h1>
            <p class="text-xs text-slate-400 mt-1 mr-8">إدارة المخزن الشخصي</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all bg-amber-600 text-white shadow-md">
                <i class="ph ph-squares-four text-xl"></i> <span class="font-medium">لوحة القيادة</span>
            </button>
            <button onclick="switchTab('inventory')" id="btn-inventory" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-package text-xl"></i> <span class="font-medium">المخزون</span>
            </button>
            <button onclick="switchTab('invoices')" id="btn-invoices" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-receipt text-xl"></i> <span class="font-medium">إصدار فاتورة</span>
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-clock-counter-clockwise text-xl"></i> <span class="font-medium">سجل الفواتير</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <div class="bg-amber-900/30 p-3 rounded-lg border border-amber-700/50">
                <p class="text-[10px] text-amber-200 leading-tight">البيانات محفوظة محلياً على هذا المتصفح فقط.</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 h-full overflow-y-auto relative">

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section p-8 space-y-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-slate-800">نظرة عامة</h2>
                <div class="text-sm text-gray-500 bg-white px-4 py-2 rounded-full border shadow-sm">
                    <span id="current-time-display"></span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">إجمالي المخزون</p>
                        <h3 id="stat-total-stock" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">قطعة</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-blue-600 shadow-lg shadow-blue-100"><i class="ph ph-package text-2xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">قيمة المخزون</p>
                        <h3 id="stat-stock-value" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">جنيه مصري</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-emerald-600 shadow-lg shadow-emerald-100"><i class="ph ph-currency-circle-dollar text-2xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">نواقص المخزون</p>
                        <h3 id="stat-low-stock" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">أصناف</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-red-500 shadow-lg shadow-red-100"><i class="ph ph-warning-circle text-2xl"></i></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mt-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-list-plus text-amber-600"></i> آخر الأصناف المضافة
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-700 border-b">
                            <tr>
                                <th class="p-3">الكود</th>
                                <th class="p-3">النوع</th>
                                <th class="p-3">العدد</th>
                                <th class="p-3">السعر</th>
                            </tr>
                        </thead>
                        <tbody id="recent-products-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory View -->
        <div id="view-inventory" class="view-section hidden p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">إدارة المخزون</h2>
                <button onclick="toggleModal('add-product-modal', true)" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-lg">
                    <i class="ph ph-plus-circle text-lg"></i> إضافة صنف جديد
                </button>
            </div>

            <div class="relative mb-6">
                <input type="text" id="inventory-search" onkeyup="renderInventoryTable()" placeholder="بحث بكود المنتج أو النوع..." class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none shadow-sm">
                <i class="ph ph-magnifying-glass absolute right-3 top-3.5 text-gray-400 text-xl"></i>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-50 text-slate-700 font-semibold border-b">
                        <tr>
                            <th class="p-4">الكود</th>
                            <th class="p-4">النوع</th>
                            <th class="p-4">الوزن (جم)</th>
                            <th class="p-4">السعر</th>
                            <th class="p-4">العدد</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Invoices View -->
        <div id="view-invoices" class="view-section hidden p-8 h-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">
                            <i class="ph ph-file-plus"></i> إنشاء فاتورة جديدة
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">اسم العميل</label>
                                <input type="text" id="inv-customer-name" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="اسم الشركة أو العميل">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                                <input type="text" disabled id="inv-date-display" class="w-full p-2 border rounded bg-gray-100 text-gray-500">
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 items-end mb-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex-1 w-full">
                                <label class="block text-sm font-medium text-gray-700 mb-1">اختر المنتج</label>
                                <select id="inv-product-select" class="w-full p-2 border rounded bg-white">
                                    <option value="">-- اختر صنف --</option>
                                </select>
                            </div>
                            <div class="w-full md:w-24">
                                <label class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                <input type="number" id="inv-qty" value="1" min="1" class="w-full p-2 border rounded">
                            </div>
                            <button onclick="addToCart()" class="bg-slate-800 text-white px-6 py-2 rounded hover:bg-slate-900 flex items-center gap-2 font-bold w-full md:w-auto justify-center transition">
                                <i class="ph ph-plus"></i> إضافة
                            </button>
                        </div>

                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full text-right bg-white">
                                <thead class="bg-gray-100 text-gray-600 text-sm">
                                    <tr>
                                        <th class="p-3">الكود</th>
                                        <th class="p-3">الصنف</th>
                                        <th class="p-3">المقاس</th>
                                        <th class="p-3">العدد</th>
                                        <th class="p-3">السعر</th>
                                        <th class="p-3">الإجمالي</th>
                                        <th class="p-3"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-table-body" class="divide-y">
                                    <tr><td colspan="7" class="text-center p-4 text-gray-400">لم يتم إضافة منتجات بعد</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-4">
                        <h3 class="text-lg font-bold mb-4 border-b pb-2">ملخص الفاتورة</h3>
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-center text-gray-600">
                                <span>عدد الأصناف:</span>
                                <span id="summary-count" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between items-center text-2xl font-bold text-slate-800">
                                <span>الإجمالي:</span>
                                <span id="summary-total" class="text-emerald-600">0 ج.م</span>
                            </div>
                        </div>
                        <button onclick="saveInvoice()" id="btn-save-invoice" disabled class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-bold shadow-lg transition disabled:bg-gray-300 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i class="ph ph-check-circle text-xl"></i> حفظ وإنشاء
                        </button>
                        <button onclick="printInvoiceNow()" id="btn-print-now" disabled class="w-full mt-2 bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg font-bold shadow-lg transition disabled:bg-gray-300 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i class="ph ph-printer text-lg"></i> طباعة مباشرة
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="view-history" class="view-section hidden p-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">سجل الفواتير السابقة</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-50 text-slate-700 border-b">
                        <tr>
                            <th class="p-4">رقم الفاتورة</th>
                            <th class="p-4">التاريخ</th>
                            <th class="p-4">العميل</th>
                            <th class="p-4">عدد الأصناف</th>
                            <th class="p-4">الإجمالي</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal: Add Product -->
    <div id="add-product-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">إضافة منتج للمخزن</h3>
                <button onclick="toggleModal('add-product-modal', false)" class="hover:text-red-300 transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <form id="product-form" onsubmit="handleAddProduct(event)" class="p-6 space-y-4">
                <input type="hidden" id="prod-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">كود المنتج</label>
                    <input required type="text" id="prod-code" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">نوع الصنف</label>
                    <input required type="text" id="prod-type" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">المقاس</label>
                        <input type="text" id="prod-size" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none" placeholder="مثال: M, L, 40">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اللون</label>
                        <input type="text" id="prod-color" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none" placeholder="مثال: أحمر، أزرق">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الوزن (جم)</label>
                        <input type="number" id="prod-weight" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الكمية المتاحة</label>
                        <input required type="number" id="prod-qty" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">سعر البيع (ج.م)</label>
                    <input required type="number" id="prod-price" class="w-full p-2 border rounded focus:ring-2 focus:ring-amber-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-amber-600 text-white py-3 rounded-lg font-bold hover:bg-amber-700 mt-4 shadow-md transition">
                    حفظ في الجهاز
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Invoice Preview -->
    <div id="invoice-preview-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 overflow-y-auto no-print">
        <div id="invoice-paper" class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden relative min-h-[500px]">
            
            <div class="bg-slate-800 p-4 flex justify-between items-center no-print text-white sticky top-0 z-10">
                <h3 class="font-bold flex items-center gap-2"><i class="ph ph-eye"></i> معاينة الفاتورة</h3>
                <div class="flex gap-3">
                    <button onclick="window.print()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-1.5 rounded font-bold flex items-center gap-2 transition">
                        <i class="ph ph-printer text-lg"></i> طباعة
                    </button>
                    <button onclick="toggleModal('invoice-preview-modal', false)" class="bg-slate-700 hover:bg-red-500 text-white px-3 py-1.5 rounded transition">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="p-10 text-slate-900 print:p-6" dir="rtl">
                <div class="border-b-4 border-slate-800 pb-6 mb-6 flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-3">
                            <img src="100.png" alt="لوغو" class="w-12 h-12 object-contain rounded" />
                            <h1 class="text-4xl font-bold text-slate-900 mb-1">النسر جروب</h1>
                        </div>
                        <p class="text-slate-600 font-bold">لمصنوعات الملابس الجاهزة</p>
                        <p class="text-sm text-slate-500 mt-2">نسخة الفواتير الشخصية</p>
                    </div>
                    <div class="text-left">
                        <h2 class="text-2xl font-bold text-gray-300">فاتورة بيع</h2>
                        <p class="font-mono mt-2 text-lg font-bold text-slate-700" id="preview-inv-number">#INV-000000</p>
                        <p class="text-sm text-gray-500 mt-1" id="preview-inv-date">--/--/----</p>
                    </div>
                </div>

                <div class="mb-8 p-4 bg-gray-50 border-r-4 border-amber-600">
                    <p class="text-lg"><span class="font-bold text-slate-700">السيد/</span> <span id="preview-customer" class="font-bold">...</span></p>
                </div>

                <table class="w-full mb-8 text-right border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-white print:bg-gray-100 print:text-black">
                            <th class="p-3 border">م</th>
                            <th class="p-3 border">كود الصنف</th>
                            <th class="p-3 border">البيان</th>
                            <th class="p-3 border">المقاس</th>
                            <th class="p-3 border">الكمية</th>
                            <th class="p-3 border">السعر</th>
                            <th class="p-3 border">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items-body"></tbody>
                </table>

                <div class="flex justify-end">
                    <div class="w-1/2 bg-slate-50 p-4 border-2 border-slate-800">
                        <div class="flex justify-between items-center text-xl font-bold text-slate-900">
                            <span>الإجمالي الكلي:</span>
                            <span id="preview-total-amount">0 ج.م</span>
                        </div>
                    </div>
                </div>

                <div class="mt-20 text-center text-xs text-gray-400 print:mt-12">
                    <p>تم استخراج هذه الفاتورة بواسطة نظام النسر جروب - المخزن الشخصي</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Logic -->
    <script>
        // --- Storage Logic ---
        const DB_KEYS = {
            PRODUCTS: 'alnasr_products',
            INVOICES: 'alnasr_invoices'
        };

        let products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS)) || [];
        let invoices = JSON.parse(localStorage.getItem(DB_KEYS.INVOICES)) || [];
        let cart = [];

        function saveData() {
            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(DB_KEYS.INVOICES, JSON.stringify(invoices));
            renderAll();
        }

        // --- App Initialization ---
        window.onload = () => {
            renderAll();
            document.getElementById('inv-date-display').value = new Date().toLocaleDateString('ar-EG');
            setInterval(() => {
                document.getElementById('current-time-display').innerText = new Date().toLocaleString('ar-EG');
            }, 1000);
        };

        function renderAll() {
            renderDashboard();
            renderInventoryTable();
            renderHistoryTable();
            updateProductDropdown();
        }

        // --- Tabs Navigation ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-300', 'hover:bg-slate-800');
            });

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            const btn = document.getElementById(`btn-${tabName}`);
            btn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            btn.classList.add('bg-amber-600', 'text-white', 'shadow-md');
        };

        // --- Dashboard Logic ---
        function renderDashboard() {
            const totalStock = products.reduce((acc, p) => acc + (Number(p.quantity) || 0), 0);
            const totalValue = products.reduce((acc, p) => acc + ((Number(p.quantity) || 0) * (Number(p.price) || 0)), 0);
            const lowStock = products.filter(p => p.quantity < 5).length;
            
            document.getElementById('stat-total-stock').innerText = totalStock.toLocaleString();
            document.getElementById('stat-stock-value').innerText = totalValue.toLocaleString();
            document.getElementById('stat-low-stock').innerText = lowStock;

            const recentBody = document.getElementById('recent-products-table');
            recentBody.innerHTML = products.length ? '' : '<tr><td colspan="4" class="p-4 text-center text-gray-400">لا توجد بيانات</td></tr>';
            
            [...products].reverse().slice(0, 5).forEach(p => {
                const info = `${p.type || ''}${p.size ? ' - ' + p.size : ''}${p.color ? ' - ' + p.color : ''}`;
                recentBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-3 font-mono text-amber-700">${p.code}</td>
                        <td class="p-3 font-bold">${info}</td>
                        <td class="p-3">${p.quantity}</td>
                        <td class="p-3 text-emerald-600 font-bold">${p.price} ج.م</td>
                    </tr>
                `;
            });
        }

        // --- Inventory Logic ---
        window.toggleModal = (id, show) => {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
        };

        window.handleAddProduct = (e) => {
            e.preventDefault();
            const existingId = document.getElementById('prod-id').value;
            const prodData = {
                code: document.getElementById('prod-code').value,
                type: document.getElementById('prod-type').value,
                weight: document.getElementById('prod-weight').value,
                quantity: Number(document.getElementById('prod-qty').value),
                price: Number(document.getElementById('prod-price').value),
                size: document.getElementById('prod-size').value,
                color: document.getElementById('prod-color').value,
            };

            if(existingId) {
                const idx = products.findIndex(p => p.id === existingId);
                if(idx !== -1) {
                    products[idx] = { ...products[idx], ...prodData };
                    saveData();
                    e.target.reset();
                    document.getElementById('prod-id').value = '';
                    toggleModal('add-product-modal', false);
                    return;
                }
            }

            const newProduct = {
                id: Date.now().toString(),
                ...prodData,
                dateAdded: new Date().toISOString()
            };

            products.push(newProduct);
            saveData();
            e.target.reset();
            document.getElementById('prod-id').value = '';
            toggleModal('add-product-modal', false);
        };

        window.renderInventoryTable = () => {
            const term = document.getElementById('inventory-search').value.toLowerCase();
            const filtered = products.filter(p => p.code.toLowerCase().includes(term) || p.type.toLowerCase().includes(term));
            
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';

            filtered.forEach(p => {
                const isLow = p.quantity < 5;
                const infoHTML = `
                    ${p.type || ''}
                    ${p.size ? `<div class="text-xs text-gray-400 mt-1">المقاس: ${p.size}</div>` : ''}
                    ${p.color ? `<div class="text-xs text-gray-400 mt-1">اللون: ${p.color}</div>` : ''}
                `;
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-4 font-mono font-bold">${p.code}</td>
                        <td class="p-4">${infoHTML}</td>
                        <td class="p-4 text-gray-500">${p.weight || '0'} جم</td>
                        <td class="p-4 font-bold">${p.price} ج.م</td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${isLow ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                                ${p.quantity}
                            </span>
                        </td>
                        <td class="p-4 flex gap-2">
                            <button onclick="editProduct('${p.id}')" class="text-sky-500 hover:text-sky-700 transition">
                                <i class="ph ph-pencil text-xl"></i>
                            </button>
                            <button onclick="deleteProduct('${p.id}')" class="text-red-400 hover:text-red-600 transition">
                                <i class="ph ph-trash text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        };

        window.deleteProduct = (id) => {
            if(confirm('هل تريد حذف هذا الصنف من جهازك؟')) {
                products = products.filter(p => p.id !== id);
                saveData();
            }
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-code').value = p.code || '';
            document.getElementById('prod-type').value = p.type || '';
            document.getElementById('prod-weight').value = p.weight || '';
            document.getElementById('prod-qty').value = p.quantity || 0;
            document.getElementById('prod-price').value = p.price || '';
            document.getElementById('prod-size').value = p.size || '';
            document.getElementById('prod-color').value = p.color || '';
            toggleModal('add-product-modal', true);
        };

        // --- Invoice Logic ---
        function updateProductDropdown() {
            const select = document.getElementById('inv-product-select');
            select.innerHTML = '<option value="">-- اختر صنف --</option>';
            products.forEach(p => {
                if(p.quantity > 0) {
                    const extra = `${p.size ? ' - ' + p.size : ''}${p.color ? ' - ' + p.color : ''}`;
                    select.innerHTML += `<option value="${p.id}">${p.code} - ${p.type}${extra} (متاح: ${p.quantity})</option>`;
                }
            });
        }

        window.addToCart = () => {
            const productId = document.getElementById('inv-product-select').value;
            const qty = Number(document.getElementById('inv-qty').value);
            
            if(!productId || qty < 1) return;
            const product = products.find(p => p.id === productId);

            if(qty > product.quantity) {
                alert('الكمية المطلوبة غير متوفرة في المخزن!');
                return;
            }

            const existing = cart.find(c => c.id === productId);
            if(existing) {
                existing.sellQuantity += qty;
                existing.total = existing.sellQuantity * existing.price;
            } else {
                cart.push({ ...product, sellQuantity: qty, total: qty * product.price });
            }
            
            renderCart();
        };

        window.removeFromCart = (idx) => {
            cart.splice(idx, 1);
            renderCart();
        };

        function renderCart() {
            const tbody = document.getElementById('cart-table-body');
            tbody.innerHTML = cart.length ? '' : '<tr><td colspan="7" class="p-4 text-center text-gray-400">لم تضف أصناف بعد</td></tr>';
            
            let total = 0;
            cart.forEach((item, idx) => {
                total += item.total;
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-mono">${item.code}</td>
                        <td class="p-3">${item.type || ''}</td>
                        <td class="p-3">${item.size || '-'}</td>
                        <td class="p-3 font-bold">${item.sellQuantity}</td>
                        <td class="p-3">${item.price}</td>
                        <td class="p-3 font-bold text-emerald-600">${item.total}</td>
                        <td class="p-3"><button onclick="removeFromCart(${idx})" class="text-red-500"><i class="ph ph-trash"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('summary-count').innerText = cart.length;
            document.getElementById('summary-total').innerText = total + ' ج.م';
            document.getElementById('btn-save-invoice').disabled = cart.length === 0;
            document.getElementById('btn-print-now').disabled = cart.length === 0;
        }

        window.saveInvoice = () => {
            const customer = document.getElementById('inv-customer-name').value || 'عميل نقدي';
            const total = cart.reduce((s, i) => s + i.total, 0);
            
            const newInvoice = {
                id: Date.now().toString(),
                invoiceNumber: 'INV-' + Math.floor(1000 + Math.random() * 9000),
                date: new Date().toISOString(),
                customerName: customer,
                items: [...cart],
                totalAmount: total
            };

            // Update stock
            cart.forEach(item => {
                const pIdx = products.findIndex(p => p.id === item.id);
                if(pIdx !== -1) products[pIdx].quantity -= item.sellQuantity;
            });

            invoices.push(newInvoice);
            saveData();
            
            // Preview & Reset
            openPreview(newInvoice);
            cart = [];
            document.getElementById('inv-customer-name').value = '';
            renderCart();
        };

        // Print current cart as an invoice preview without saving
        window.printInvoiceNow = () => {
            if(cart.length === 0) return alert('لا توجد منتجات للطباعة.');
            const customer = document.getElementById('inv-customer-name').value || 'عميل نقدي';
            const total = cart.reduce((s, i) => s + i.total, 0);
            const tempInv = {
                id: 'preview-' + Date.now().toString(),
                invoiceNumber: 'INV-PREVIEW-' + Math.floor(1000 + Math.random() * 9000),
                date: new Date().toISOString(),
                customerName: customer,
                items: [...cart],
                totalAmount: total
            };
            openPreview(tempInv);
            // allow modal to render then trigger print
            setTimeout(() => window.print(), 300);
        };

        // --- History & Reprint ---
        window.renderHistoryTable = () => {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            [...invoices].reverse().forEach(inv => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b transition">
                        <td class="p-4 font-mono font-bold text-amber-700">${inv.invoiceNumber}</td>
                        <td class="p-4 text-sm">${new Date(inv.date).toLocaleDateString('ar-EG')}</td>
                        <td class="p-4 font-bold">${inv.customerName}</td>
                        <td class="p-4">${inv.items.length}</td>
                        <td class="p-4 font-bold text-emerald-600">${inv.totalAmount} ج.م</td>
                        <td class="p-4 flex gap-2">
                            <button onclick="reprint('${inv.id}')" class="bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100"><i class="ph ph-printer text-xl"></i></button>
                            <button onclick="deleteInvoice('${inv.id}')" class="bg-red-50 text-red-500 p-2 rounded hover:bg-red-100"><i class="ph ph-trash text-xl"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.reprint = (id) => {
            const inv = invoices.find(i => i.id === id);
            if(inv) openPreview(inv);
        };

        window.deleteInvoice = (id) => {
            if(confirm('حذف سجل هذه الفاتورة من جهازك؟')) {
                invoices = invoices.filter(i => i.id !== id);
                saveData();
            }
        };

        function openPreview(inv) {
            document.getElementById('preview-inv-number').innerText = inv.invoiceNumber;
            document.getElementById('preview-inv-date').innerText = new Date(inv.date).toLocaleDateString('ar-EG');
            document.getElementById('preview-customer').innerText = inv.customerName;
            document.getElementById('preview-total-amount').innerText = inv.totalAmount + ' ج.م';
            
            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            inv.items.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td class="p-2 border text-center">${idx + 1}</td>
                        <td class="p-2 border font-mono">${item.code}</td>
                        <td class="p-2 border">${item.type || ''}</td>
                        <td class="p-2 border text-center">${item.size || '-'}</td>
                        <td class="p-2 border text-center">${item.sellQuantity}</td>
                        <td class="p-2 border text-center">${item.price}</td>
                        <td class="p-2 border text-center font-bold">${item.total}</td>
                    </tr>
                `;
            });

            toggleModal('invoice-preview-modal', true);
        }
    </script>
</body>
</html>