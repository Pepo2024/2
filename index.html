<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النسر جروب - إدارة المصنع (نسخة خاصة)</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }

            /* لم يعد هناك إخفاء لأي عنصر في وضع fullscreen، فقط يبقى كل شيء ظاهر */

        /* Print Styles */
        @media print {
            .no-print, aside, nav, .view-section:not(#invoice-preview-modal), #main-content > *:not(#invoice-preview-modal) {
                display: none !important;
            }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; color-adjust: exact; }
            #invoice-preview-modal { position: static; background: white; padding: 0; display: block !important; }
            #invoice-paper {
                box-shadow: none;
                border: none;
                border-radius: 0;
                width: 210mm;
                max-width: 210mm;
                min-width: 210mm;
                margin-left: auto;
                margin-right: auto;
                margin-top: 0;
                margin-bottom: 0;
                padding: 0;
                min-height: auto;
                max-height: none;
                height: auto;
                display: block;
                page-break-inside: avoid !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
            }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #e5e7eb; padding: 6px; }
            .ph { display: none; }
            tr, td, th { page-break-inside: avoid; }
            .text-slate-800, .text-slate-900, .text-emerald-600 { color: inherit; }
            html, body { width: 210mm; min-width: 210mm; max-width: 210mm; height: 297mm; min-height: 297mm; max-height: 297mm; overflow: hidden; }
            #invoice-preview-modal { min-height: 100vh; page-break-inside: avoid !important; page-break-after: avoid !important; }
            * { page-break-inside: avoid !important; }
        }

        @page { size: A4 portrait; margin: 0mm; }

        /* Mobile-first responsiveness */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            
            aside {
                display: none !important;
            }
            
            #main-content {
                flex: 1;
                width: 100%;
                padding: 0 !important;
                background-color: #f5f7fa;
            }
            
            .view-section {
                padding: 14px !important;
                margin-top: 70px;
                background-color: #f5f7fa;
            }
        }

        /* Tablet responsiveness */
        @media (max-width: 1024px) {
            .w-64 { width: 56px; }
            .w-64 .font-medium { display: none; }
            .w-64 p { display: none; }
            #main-content { padding: 4px; }
            .view-section { padding: 4px !important; }
            .grid { gap: 2px !important; }
            table { font-size: 12px; }
            th, td { padding: 3px !important; }
        }

        /* Mobile responsiveness (improved) */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
                background-color: #f5f7fa;
            }
            
            #main-content {
                width: 100%;
                padding: 0 !important;
                overflow-y: auto;
            }
            
            .view-section {
                padding: 14px !important;
                margin-top: 0;
                background-color: #f5f7fa;
            }
            
            h1 {
                font-size: 1.75rem !important;
                color: #fbbf24 !important;
                font-weight: bold !important;
                margin: 0 0 16px 0 !important;
            }
            
            h2 {
                font-size: 1.4rem !important;
                color: #1e293b !important;
                font-weight: 700 !important;
                margin: 16px 0 14px 0 !important;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            h3 {
                font-size: 1.15rem !important;
                color: #1e293b !important;
                font-weight: 700 !important;
                margin: 14px 0 10px 0 !important;
            }
            
            p, span, label {
                font-size: 14px !important;
                color: #475569 !important;
                font-weight: 500 !important;
                line-height: 1.55 !important;
            }
            
            label {
                color: #1e293b !important;
                display: block !important;
                margin-bottom: 6px !important;
                font-weight: 600 !important;
                font-size: 13px !important;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
                gap: 14px !important;
            }
            
            table {
                font-size: 13px;
                border: 1px solid #cbd5e1;
                margin: 14px 0 !important;
                border-radius: 8px;
                overflow: hidden;
                width: 100%;
                border-collapse: collapse;
                background-color: white;
            }
            
            th {
                background: linear-gradient(135deg, #1e293b, #334155) !important;
                color: white !important;
                font-weight: 700 !important;
                padding: 12px 10px !important;
                border: none !important;
                text-align: right;
                font-size: 12px !important;
                line-height: 1.4;
            }
            
            td {
                padding: 12px 10px !important;
                border-bottom: 1px solid #e2e8f0 !important;
                color: #334155 !important;
                font-size: 13px !important;
            }
            
            tr:hover {
                background-color: #f0f4f8 !important;
            }
            
            tbody tr {
                background-color: white;
            }
            
            tbody tr:nth-child(even) {
                background-color: #fafbfc;
            }
            
            button {
                padding: 12px 16px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                border: none !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
                margin-bottom: 10px !important;
                line-height: 1.4;
            }
            
            button:active {
                transform: scale(0.98);
            }
            
            input, select, textarea {
                padding: 11px 12px !important;
                font-size: 15px !important;
                border: 2px solid #cbd5e1 !important;
                border-radius: 6px !important;
                background-color: white !important;
                color: #1e293b !important;
                width: 100% !important;
                margin-bottom: 10px !important;
                box-sizing: border-box !important;
            }
            
            input:focus, select:focus, textarea:focus {
                border-color: #f59e0b !important;
                outline: none !important;
                box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
            }
            
            .bg-white {
                background-color: white !important;
                border-radius: 12px !important;
                margin-bottom: 14px !important;
                border: 1px solid #e2e8f0 !important;
            }
            
            .rounded-xl {
                border-radius: 12px !important;
                margin-bottom: 14px !important;
            }
            
            .p-6 {
                padding: 14px !important;
            }
            
            .p-4 {
                padding: 12px !important;
            }
            
            .p-8 {
                padding: 14px !important;
            }
            
            .p-3 {
                padding: 10px !important;
            }
            
            .gap-4 {
                gap: 14px !important;
            }
            
            .gap-6 {
                gap: 16px !important;
            }
            
            .gap-2 {
                gap: 8px !important;
            }
            
            .space-y-6 > * + * {
                margin-top: 14px !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 12px !important;
            }
            
            .mb-6 {
                margin-bottom: 16px !important;
            }
            
            .mt-6 {
                margin-top: 16px !important;
            }
            
            .mt-8 {
                margin-top: 16px !important;
            }
            
            .overflow-x-auto {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
            }
            
            input[readonly], input[disabled] {
                background-color: #f1f5f9 !important;
                color: #64748b !important;
            }
            
            /* Form groups */
            form > div {
                margin-bottom: 10px !important;
            }
            
            form > div:last-child {
                margin-bottom: 0 !important;
            }
            
            .flex.justify-between.items-center {
                flex-direction: column;
                gap: 12px;
                align-items: stretch !important;
            }
            
            p, span {
                line-height: 1.55 !important;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Modal header / brand - compact slightly darker white header with soft accent */
        .modal-header {
            background: #f3efe9; /* slightly darker than pure white */
            color: #0f172a;
            padding: 8px 12px;
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid rgba(15,23,42,0.06);
            box-shadow: 0 1px 6px rgba(2,6,23,0.06);
            position: relative;
        }

        .modal-header .icon-wrapper {
            background: rgba(180,83,9,0.08); /* soft amber background for icon */
            color: #b45309; /* amber icon color */
            padding: 6px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
        }

        .modal-header h3 { color: #0f172a; font-size: 15px; margin: 0; }
        .modal-header p { color: #6b7280; font-size: 12px; margin: 0; }

        .modal-header button { background: transparent; color: #0f172a; padding: 6px; border-radius: 8px; }

        /* CTA button used in modals (muted amber) */
        .modal-cta {
            background-color: #b45309;
            color: white;
        }

        /* Mobile-specific: move close button to top-left and adjust padding */
        @media (max-width: 768px) {
            .modal-header {
                padding: 10px 12px 12px 52px; /* extra left padding to avoid overlap with button */
            }

            .modal-header button {
                position: absolute;
                top: 8px;
                left: 8px; /* top-left on mobile */
                background: rgba(15,23,42,0.04);
                backdrop-filter: blur(2px);
            }
        }

        /* Dashboard mobile styling - Enhanced */
        @media (max-width: 768px) {
            #view-dashboard {
                padding: 14px !important;
                background-color: #f5f7fa;
            }
            
            #view-dashboard h2 {
                font-size: 1.35rem !important;
                margin-bottom: 16px !important;
                padding-bottom: 10px;
                border-bottom: 3px solid #fbbf24;
                color: #1e293b;
                font-weight: 700;
            }
            
            #view-dashboard .grid {
                gap: 10px !important;
                margin-bottom: 14px;
            }
            
            #view-dashboard .bg-white {
                padding: 12px !important;
                border-radius: 10px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            #view-dashboard h3 {
                font-size: 1.25rem !important;
                margin-top: 8px !important;
            }
            
            #view-dashboard p {
                font-size: 12px !important;
            }
            
            #view-dashboard .p-6 {
                padding: 14px !important;
            }
        }
        
        /* Hide scrollbar on mobile main content */
        @media (max-width: 768px) {
            #main-content::-webkit-scrollbar {
                display: none;
            }
            
            #main-content {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        /* Mobile sidebar toggle */
        @media (max-width: 768px) {
            aside.sidebar-open {
                display: flex !important;
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 40;
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
                animation: slideIn 0.3s ease-out;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* Hide hamburger button when sidebar is open */
            #hamburger-btn.sidebar-open-btn {
                display: none !important;
            }
            
            /* Show all text in sidebar on mobile */
            aside.sidebar-open .font-medium {
                display: block !important;
            }
            
            aside.sidebar-open p {
                display: block !important;
            }
            
            aside.sidebar-open nav {
                flex: 1;
            }
            
            /* Hide scrollbar for sidebar */
            aside.sidebar-open::-webkit-scrollbar {
                display: none;
            }
            
            aside.sidebar-open {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(-100%);
                }
                to {
                    transform: translateX(0);
                }
            }
            
            /* Employees mobile styling */
            #view-employees {
                padding: 14px !important;
            }
            
            #view-employees h2 {
                font-size: 1.3rem !important;
                margin-bottom: 14px !important;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            #view-employees h3 {
                font-size: 1.15rem !important;
                margin-top: 16px !important;
                margin-bottom: 12px !important;
            }
            
            #view-employees .bg-white {
                padding: 12px !important;
            }
            
            #view-employees form {
                gap: 10px !important;
            }
            
            #view-employees button {
                padding: 11px 14px !important;
                font-size: 13px !important;
            }
            
            #view-employees input, 
            #view-employees select {
                font-size: 14px !important;
                padding: 10px 11px !important;
            }
            
            #view-employees table {
                font-size: 12px;
            }
            
            #view-employees th {
                padding: 10px 8px !important;
                font-size: 11px !important;
            }
            
            #view-employees td {
                padding: 10px 8px !important;
                font-size: 12px !important;
            }
        }

        #hamburger-btn {
            display: none;
        }

        @media (max-width: 768px) {
            #hamburger-btn {
                display: flex;
            }
            
            /* Incoming mobile styling */
            #view-incoming {
                padding: 14px !important;
            }
            
            #view-incoming h2 {
                font-size: 1.3rem !important;
                margin-bottom: 12px !important;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            #view-incoming button {
                font-size: 13px !important;
                padding: 10px 12px !important;
            }
            
            #view-incoming table {
                font-size: 11px;
            }
            
            #view-incoming th {
                padding: 10px 6px !important;
                font-size: 10px !important;
            }
            
            #view-incoming td {
                padding: 10px 6px !important;
                font-size: 11px !important;
            }
            
            /* Invoices/Create mobile styling - Enhanced */
            #view-invoices {
                padding: 14px !important;
                background-color: #f5f7fa;
            }
            
            #view-invoices h2 {
                font-size: 1.35rem !important;
                margin-bottom: 16px !important;
                padding-bottom: 10px;
                border-bottom: 3px solid #fbbf24;
                color: #1e293b;
                font-weight: 700;
            }
            
            #view-invoices .bg-white {
                padding: 16px !important;
                border-radius: 12px !important;
                margin-bottom: 14px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            #view-invoices .grid {
                gap: 12px !important;
            }
            
            #view-invoices input,
            #view-invoices select {
                font-size: 14px !important;
                padding: 11px 13px !important;
                margin-bottom: 10px !important;
                border: 2px solid #e2e8f0 !important;
                border-radius: 8px !important;
            }
            
            #view-invoices input:focus,
            #view-invoices select:focus {
                border-color: #f59e0b !important;
                box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
            }
            
            #view-invoices label {
                font-size: 13px !important;
                margin-bottom: 5px !important;
                font-weight: 600;
                color: #1e293b;
            }
            
            #view-invoices button {
                font-size: 13px !important;
                padding: 11px 14px !important;
                border-radius: 8px !important;
                font-weight: 700;
                transition: all 0.2s;
            }
            
            #view-invoices button:active {
                transform: scale(0.98);
            }
            
            #view-invoices table {
                font-size: 12px;
                margin: 10px 0 !important;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
            }
            
            #view-invoices th {
                padding: 10px 8px !important;
                font-size: 11px !important;
                background: linear-gradient(135deg, #1e293b, #334155) !important;
                color: white !important;
                font-weight: 700;
            }
            
            #view-invoices td {
                padding: 9px 8px !important;
                font-size: 12px !important;
                border-bottom: 1px solid #f1f5f9 !important;
            }
            
            #view-invoices h3 {
                font-size: 1.2rem !important;
                margin-bottom: 12px !important;
                color: #1e293b;
                font-weight: 700;
            }
            
            #view-invoices .sticky {
                top: 0;
                background-color: white;
                z-index: 10;
                border-radius: 8px;
                padding: 14px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            /* Invoice History Table Mobile Styling */
            #view-history {
                padding: 14px !important;
            }
            
            #view-history h2 {
                font-size: 1.35rem;
                margin-bottom: 14px;
                color: #1e293b;
                font-weight: 700;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            #view-history table {
                font-size: 12px;
                margin: 0;
                background-color: white;
            }
            
            #view-history th {
                padding: 10px 8px !important;
                font-size: 11px;
                text-align: center;
                font-weight: 700;
                background: linear-gradient(135deg, #1e293b, #334155) !important;
                color: white !important;
            }
            
            #view-history td {
                padding: 10px 8px !important;
                text-align: center;
                font-size: 12px;
            }
            
            #view-history button {
                padding: 8px 6px !important;
                font-size: 11px !important;
            }
            
            .hidden-mobile {
                display: none !important;
            }
            
            /* Compact invoice number */
            .invoice-col-number {
                max-width: 80px;
                word-break: break-word;
            }
            
            /* Password Modal Mobile Styling */
            #password-prompt-modal {
                padding: 12px !important;
            }
            
            #password-prompt-modal .bg-white {
                max-width: 90vw !important;
                width: 90vw !important;
                margin: 0 auto !important;
            }
            
            #password-prompt-modal .bg-gradient-to-r {
                padding: 16px 20px !important;
            }
            
            #password-prompt-modal h2 {
                font-size: 18px !important;
            }
            
            #password-prompt-modal p {
                font-size: 11px !important;
            }
            
            #password-prompt-modal h3 {
                font-size: 18px !important;
            }
            
            #password-prompt-modal input[type="password"] {
                font-size: 15px !important;
                padding: 12px 14px !important;
            }
            
            #password-prompt-modal .flex {
                gap: 8px !important;
            }
            
            #password-prompt-modal input[type="checkbox"] {
                width: 18px !important;
                height: 18px !important;
                margin: 0 !important;
            }
            
            #password-prompt-modal label {
                font-size: 13px !important;
            }
            
            #password-prompt-modal button {
                padding: 14px 16px !important;
                font-size: 15px !important;
            }
            
            #password-prompt-modal .p-6 {
                padding: 20px 16px !important;
            }
            
            /* Modal Headers Mobile Styling */
            #add-product-modal .bg-slate-900,
            #add-incoming-modal .bg-slate-900 {
                padding: 8px 12px !important;
            }
            
            #add-product-modal h3,
            #add-incoming-modal h3 {
                font-size: 13px !important;
            }
            
            #add-product-modal button i,
            #add-incoming-modal button i {
                font-size: 14px !important;
            }
            
            /* Modal Content Styling - Enhanced */
            #add-product-modal .bg-white,
            #add-incoming-modal .bg-white {
                border-radius: 16px !important;
                margin: 20px auto !important;
                max-width: 95vw !important;
            }
            
            /* Product Modal Specific */
            #add-product-modal .bg-gradient-to-r {
                border-radius: 16px 16px 0 0;
            }
            
            #add-product-modal form {
                padding: 24px !important;
                gap: 12px !important;
            }
            
            #add-product-modal input, 
            #add-product-modal label {
                font-size: 13px !important;
            }
            
            #add-product-modal .grid {
                gap: 12px !important;
            }
            
            #add-product-modal button[type="submit"] {
                padding: 14px 18px !important;
                font-size: 14px !important;
                margin-top: 8px !important;
            }
            
            #add-product-modal .space-y-3 > * + * {
                margin-top: 12px !important;
            }
            
            /* Incoming Modal Specific */
            #add-incoming-modal .bg-gradient-to-r {
                border-radius: 16px 16px 0 0;
            }
            
            #add-incoming-modal form {
                padding: 24px !important;
                gap: 12px !important;
            }
            
            #add-incoming-modal input, 
            #add-incoming-modal label {
                font-size: 13px !important;
            }
            
            #add-incoming-modal .grid {
                gap: 12px !important;
            }
            
            #add-incoming-modal button[type="submit"] {
                padding: 14px 18px !important;
                font-size: 14px !important;
                margin-top: 8px !important;
            }
            
            #add-incoming-modal .space-y-3 > * + * {
                margin-top: 12px !important;
            }
            
            /* Image Preview Styling */
            #incoming-image-preview {
                padding: 12px !important;
                background-color: #f9fafb !important;
            }
            
            #incoming-image-thumb {
                width: 80px !important;
                height: 80px !important;
            }
            
            /* Inventory Mobile Styling */
            #view-inventory {
                padding: 14px !important;
            }
            
            #view-inventory h2 {
                font-size: 1.35rem !important;
                margin-bottom: 12px !important;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }
            
            #view-inventory button {
                font-size: 13px !important;
                padding: 10px 12px !important;
            }
            
            #view-inventory input {
                font-size: 14px !important;
                padding: 11px 12px !important;
            }
            
            #view-inventory .inventory-table {
                font-size: 12px;
            }
            
            #view-inventory th {
                padding: 10px 8px !important;
                font-size: 11px !important;
                background: linear-gradient(135deg, #1e293b, #334155) !important;
                color: white !important;
            }
            
            #view-inventory td {
                padding: 10px 8px !important;
                font-size: 12px !important;
            }
            
            #view-inventory button i {
                font-size: 13px !important;
            }
        }
    </style>

</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex">

    <!-- Hamburger Button (Mobile) -->
    <button id="hamburger-btn" onclick="toggleSidebar()" class="fixed top-4 left-4 bg-amber-600 hover:bg-amber-700 text-white p-4 rounded-lg z-50 flex items-center gap-2 transition shadow-lg">
        <i class="ph ph-list text-2xl"></i>
        <span class="font-bold text-base">القائمة</span>
    </button>

    <!-- Main Container -->
    <div class="flex flex-1 w-full">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-white flex-col hidden md:flex no-print shadow-xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-500 flex items-center gap-2">
                <img src="100.png" alt="لوغو" class="w-8 h-8 object-contain rounded"> النسر جروب
            </h1>
            <p class="text-xs text-slate-400 mt-1 mr-8">إدارة المخزن الشخصي</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all bg-amber-600 text-white shadow-md">
                <i class="ph ph-squares-four text-xl"></i> <span class="font-medium">لوحة القيادة</span>
            </button>
            <button onclick="switchTab('inventory')" id="btn-inventory" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-package text-xl"></i> <span class="font-medium">المخزون</span>
            </button>
            <button onclick="switchTab('invoices')" id="btn-invoices" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-receipt text-xl"></i> <span class="font-medium">إصدار فاتورة</span>
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-clock-counter-clockwise text-xl"></i> <span class="font-medium">سجل الفواتير</span>
            </button>
            <button onclick="switchTab('incoming')" id="btn-incoming" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-truck text-xl"></i> <span class="font-medium">الواردات</span>
            </button>
            <button onclick="switchTab('employees')" id="btn-employees" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-user-circle text-xl"></i> <span class="font-medium">الموظفين</span>
            </button>
            <button onclick="switchTab('backup')" id="btn-backup" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-300 hover:bg-slate-800 hover:text-white">
                <i class="ph ph-shield-check text-xl"></i> <span class="font-medium">نسخ احتياطي</span>
            </button>
        </nav>
        <div class="p-4 space-y-2 border-y border-slate-700">
            <button onclick="toggleFullscreen()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg font-bold shadow transition flex items-center justify-center gap-2">
                <i class="ph ph-arrows-out-simple text-lg"></i> تكبير
            </button>
        </div>
        <div class="p-4 border-t border-slate-700">
            <div class="bg-amber-900/30 p-3 rounded-lg border border-amber-700/50">
                <p class="text-[10px] text-amber-200 leading-tight">البيانات محفوظة محلياً على هذا المتصفح فقط.</p>
            </div>
            <div class="mt-3 text-center">
                <p class="text-xs text-slate-400">
                    جميع الحقوق محفوظة © 2026 - 
                    <a href="https://www.facebook.com/share/1ADdrmGw8e/" target="_blank" class="text-white hover:text-amber-400 transition font-bold">
                        PEPO MELAD
                    </a>
                </p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 h-full overflow-y-auto relative w-full">

        <!-- Notification Toast -->
        <div id="notification-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 opacity-0 pointer-events-none transition-all duration-300 flex items-center gap-2">
            <i class="ph ph-check-circle text-xl"></i>
            <span id="notification-message">تم الحفظ بنجاح!</span>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section p-8 space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-slate-800">نظرة عامة</h2>
                <div class="text-sm text-gray-500 bg-white px-4 py-2 rounded-full border shadow-sm w-full md:w-auto">
                    <span id="current-time-display"></span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">إجمالي المخزون</p>
                        <h3 id="stat-total-stock" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">قطعة</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-blue-600 shadow-lg shadow-blue-100"><i class="ph ph-package text-2xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">قيمة المخزون</p>
                        <h3 id="stat-stock-value" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">جنيه مصري</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-emerald-600 shadow-lg shadow-emerald-100"><i class="ph ph-currency-circle-dollar text-2xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">إجمالي المبالغ الواردة</p>
                        <h3 id="stat-incoming-value" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">جنيه مصري</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-purple-600 shadow-lg shadow-purple-100"><i class="ph ph-truck text-2xl"></i></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">نواقص المخزون</p>
                        <h3 id="stat-low-stock" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                        <p class="text-xs text-gray-400 mt-1">أصناف</p>
                    </div>
                    <div class="p-3 rounded-lg text-white bg-red-500 shadow-lg shadow-red-100"><i class="ph ph-warning-circle text-2xl"></i></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mt-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-list-plus text-amber-600"></i> آخر الأصناف المضافة
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-700 border-b">
                            <tr>
                                <th class="p-3">الكود</th>
                                <th class="p-3">النوع</th>
                                <th class="p-3">العدد</th>
                                <th class="p-3">السعر</th>
                            </tr>
                        </thead>
                        <tbody id="recent-products-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory View -->
        <div id="view-inventory" class="view-section hidden p-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                <h2 class="text-2xl font-bold text-slate-800">إدارة المخزون</h2>
                <button onclick="resetProductForm(); toggleModal('add-product-modal', true)" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-3 rounded-lg flex items-center gap-2 transition shadow-lg w-full md:w-auto justify-center md:justify-start font-bold">
                    <i class="ph ph-plus-circle text-lg"></i> إضافة صنف
                </button>
            </div>

            <div class="relative mb-6">
                <input type="text" id="inventory-search" onkeyup="renderInventoryTable()" placeholder="بحث بالكود أو النوع..." class="w-full p-3 pr-10 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none shadow-sm">
                <i class="ph ph-magnifying-glass absolute right-3 top-3.5 text-gray-400 text-xl"></i>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                <table class="w-full text-right inventory-table">
                    <thead class="bg-gradient-to-r from-slate-900 to-slate-700 text-white font-bold border-b">
                        <tr>
                            <th class="p-3 text-sm">الكود</th>
                            <th class="p-3 text-sm">النوع</th>
                            <th class="p-3 text-sm hidden-mobile">الوزن</th>
                            <th class="p-3 text-sm">السعر</th>
                            <th class="p-3 text-sm">العدد</th>
                            <th class="p-3 text-sm">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Invoices View -->
        <div id="view-invoices" class="view-section hidden p-8 h-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">
                            <i class="ph ph-file-plus"></i> إنشاء فاتورة جديدة
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">اسم العميل</label>
                                <input type="text" id="inv-customer-name" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="اسم الشركة أو العميل">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                                <input type="text" disabled id="inv-date-display" class="w-full p-2 border rounded bg-gray-100 text-gray-500">
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 items-end mb-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex-1 w-full">
                                <label class="block text-sm font-medium text-gray-700 mb-1">اختر المنتج</label>
                                <select id="inv-product-select" class="w-full p-2 border rounded bg-white">
                                    <option value="">-- اختر صنف --</option>
                                </select>
                            </div>
                            <div class="w-full md:w-24">
                                <label class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                <input type="number" id="inv-qty" value="1" min="1" class="w-full p-2 border rounded">
                            </div>
                            <button onclick="addToCart()" class="bg-slate-800 text-white px-6 py-2 rounded hover:bg-slate-900 flex items-center gap-2 font-bold w-full md:w-auto justify-center transition">
                                <i class="ph ph-plus"></i> إضافة
                            </button>
                        </div>

                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full text-right bg-white">
                                <thead class="bg-gray-100 text-gray-600 text-sm">
                                    <tr>
                                        <th class="p-3">الكود</th>
                                        <th class="p-3">الصنف</th>
                                        <th class="p-3">المقاس</th>
                                        <th class="p-3">العدد</th>
                                        <th class="p-3">السعر</th>
                                        <th class="p-3">الإجمالي</th>
                                        <th class="p-3"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-table-body" class="divide-y">
                                    <tr><td colspan="7" class="text-center p-4 text-gray-400">لم يتم إضافة منتجات بعد</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-4">
                        <h3 class="text-lg font-bold mb-4 border-b pb-2">ملخص الفاتورة</h3>
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between items-center text-gray-600">
                                <span>عدد الأصناف:</span>
                                <span id="summary-count" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between items-center text-2xl font-bold text-slate-800">
                                <span>الإجمالي:</span>
                                <span id="summary-total" class="text-emerald-600">0 ج.م</span>
                            </div>
                            <div class="border-t pt-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ المدفوع</label>
                                <input type="number" id="inv-paid-amount" value="0" min="0" oninput="updateRemainingBalance()" class="w-full p-3 border-2 border-amber-300 rounded-lg focus:border-amber-600 focus:outline-none text-lg font-bold">
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex justify-between items-center text-lg">
                                        <span class="font-bold text-slate-800">الرصيد المتبقي:</span>
                                        <span id="remaining-balance" class="font-bold text-blue-600 text-xl">0 ج.م</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="saveInvoice()" id="btn-save-invoice" disabled class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-bold shadow-lg transition disabled:bg-gray-300 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i class="ph ph-check-circle text-xl"></i> حفظ وإنشاء
                        </button>
                        <button onclick="printInvoiceNow()" id="btn-print-now" disabled class="w-full mt-2 bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg font-bold shadow-lg transition disabled:bg-gray-300 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                            <i class="ph ph-printer text-lg"></i> طباعة مباشرة
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div id="view-history" class="view-section hidden p-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">سجل الفواتير السابقة</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                <table class="w-full text-right table-invoice-history">
                    <thead class="bg-gradient-to-r from-slate-900 to-slate-700 text-white border-b">
                        <tr>
                            <th class="p-4 font-bold text-sm invoice-col-number">رقم الفاتورة</th>
                            <th class="p-4 font-bold text-sm invoice-col-date">التاريخ</th>
                            <th class="p-4 font-bold text-sm invoice-col-customer">العميل</th>
                            <th class="p-4 font-bold text-sm invoice-col-items hidden-mobile">عدد الأصناف</th>
                            <th class="p-4 font-bold text-sm invoice-col-total">الإجمالي</th>
                            <th class="p-4 font-bold text-sm invoice-col-paid hidden-mobile">المدفوع</th>
                            <th class="p-4 font-bold text-sm invoice-col-balance">الرصيد</th>
                            <th class="p-4 font-bold text-sm invoice-col-actions">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Incoming View -->
        <div id="view-incoming" class="view-section hidden p-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-slate-800">إدارة الوارد (المشتريات)</h2>
                <button onclick="resetIncomingForm(); toggleModal('add-incoming-modal', true)" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-lg w-full md:w-auto justify-center md:justify-start">
                    <i class="ph ph-plus-circle text-lg"></i> إضافة وارد جديد
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-50 text-slate-700 border-b">
                        <tr>
                            <th class="p-4">كود الفاتورة</th>
                            <th class="p-4">التاريخ</th>
                            <th class="p-4">الصنف</th>
                            <th class="p-4">اللون</th>
                            <th class="p-4">العدد</th>
                            <th class="p-4">الوزن</th>
                            <th class="p-4">قيمة الفاتورة</th>
                            <th class="p-4">صورة الفاتورة</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="incoming-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
        <!-- Backup View -->
        <div id="view-backup" class="view-section hidden p-8">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <i class="ph ph-shield-check text-amber-600"></i> نسخ احتياطي للبيانات
                </h2>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                        <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center gap-2">
                            <i class="ph ph-download text-xl"></i> حفظ نسخة احتياطية
                        </h3>
                        <p class="text-sm text-blue-700 mb-4">احفظ جميع بيانات النظام (المنتجات، الفواتير، الوارد) كملف على جهازك للحماية من فقدان البيانات</p>
                        <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                            <i class="ph ph-download text-lg"></i> حفظ على الجهاز
                        </button>
                    </div>

                    <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                        <h3 class="text-lg font-bold text-green-800 mb-3 flex items-center gap-2">
                            <i class="ph ph-upload text-xl"></i> استعادة البيانات
                        </h3>
                        <p class="text-sm text-green-700 mb-4">استعادة البيانات من ملف نسخة احتياطية محفوظ على جهازك</p>
                        <input type="file" id="backup-file" accept=".json" class="w-full p-3 border border-green-300 rounded-lg mb-3 focus:ring-2 focus:ring-green-500 outline-none">

                <!-- Backup fallback modal (for mobile / PWA cases where downloads are blocked) -->
                <div id="backup-fallback-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-3">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="text-sm font-bold backup-filename">اسم الملف</div>
                                <div class="text-xs text-gray-500">إذا لم يتم تنزيل الملف تلقائياً، يمكنك نسخه أو مشاركته</div>
                            </div>
                            <button onclick="closeBackupFallback()" class="p-2 rounded bg-gray-100"><i class="ph ph-x"></i></button>
                        </div>
                        <textarea class="w-full h-48 p-3 border rounded mb-3 text-xs font-mono" readonly></textarea>
                        <div class="flex gap-2">
                            <button onclick="copyBackupToClipboard()" class="flex-1 bg-slate-800 text-white py-2 rounded">نسخ</button>
                            <button onclick="shareBackupText()" class="flex-1 bg-amber-600 text-white py-2 rounded">مشاركة</button>
                            <button onclick="downloadAndOpenGoogle()" class="flex-1 bg-blue-600 text-white py-2 rounded">تحميل وفتح Google</button>
                            <button onclick="openBackupInNewTab()" class="flex-1 bg-gray-200 py-2 rounded">فتح</button>
                        </div>    
                    </div>
                </div>
                        <button onclick="importData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                            <i class="ph ph-upload text-lg"></i> رفع واستعادة البيانات
                        </button>
                    </div>

                    <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                        <h3 class="text-lg font-bold text-red-800 mb-3 flex items-center gap-2">
                            <i class="ph ph-warning text-xl"></i> مسح جميع البيانات
                        </h3>
                        <p class="text-sm text-red-700 mb-4">حذف جميع البيانات نهائياً (لا يمكن التراجع عن هذا الإجراء)</p>
                        <button onclick="clearAllData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                            <i class="ph ph-trash text-lg"></i> مسح جميع البيانات
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Employees View -->
        <div id="view-employees" class="view-section hidden p-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-slate-800">الموظفين وحساب الأجر اليومي</h2>
                <div class="text-sm text-gray-500 bg-white px-4 py-2 rounded-full border shadow-sm w-full md:w-auto text-center md:text-right">
                    يمكن الوصول للموقع من الهاتف وحفظ البيانات محلياً
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <form id="employee-form" onsubmit="handleEmployeeForm(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input type="hidden" id="emp-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم الموظف</label>
                        <input type="text" id="emp-name" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="مثال: أحمد محمد" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">رقم التليفون</label>
                        <input type="tel" id="emp-phone" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="01XXXXXXXXX" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">راتب الشهر (ج.م)</label>
                        <input type="number" id="emp-monthly" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="مثال: 5000" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الشهر للحساب</label>
                        <input type="month" id="emp-month" class="w-full p-2 border rounded focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الأيام المحسوبة</label>
                        <input type="text" id="emp-working-days" class="w-full p-2 border rounded bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الأجر اليومي</label>
                        <input type="text" id="emp-daily-rate" class="w-full p-2 border rounded bg-gray-100" readonly>
                    </div>

                    <div class="md:col-span-3 flex flex-col md:flex-row gap-2">
                        <button type="button" onclick="calculateDailyForForm()" class="bg-slate-800 text-white px-4 py-2 rounded-lg flex-1">حساب الأجر اليومي</button>
                        <button id="employee-submit-btn" type="submit" class="bg-amber-600 text-white px-4 py-2 rounded-lg flex-1">حفظ الموظف</button>
                        <button type="button" onclick="resetEmployeeForm()" class="bg-gray-200 px-4 py-2 rounded-lg flex-1">إعادة</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
                <table class="w-full text-right">
                    <thead class="bg-slate-50 text-slate-700 border-b">
                        <tr>
                            <th class="p-4">الاسم</th>
                            <th class="p-4">الهاتف</th>
                            <th class="p-4">راتب الشهر</th>
                            <th class="p-4">أجر اليوم (لشهر محدد)</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="employees-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <!-- Attendance Section -->
            <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-clipboard-list"></i> تسجيل الحضور
                </h3>
                <form id="attendance-form" onsubmit="handleAttendanceForm(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اختر الموظف</label>
                        <select id="att-employee" class="w-full p-2 border rounded focus:ring-amber-500" required>
                            <option value="">-- اختر موظف --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                        <input type="text" id="att-date" class="w-full p-2 border rounded focus:ring-amber-500" placeholder="مثال: 29/01/2026" required oninput="formatArabicDateInput(this)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الحالة</label>
                        <select id="att-status" class="w-full p-2 border rounded focus:ring-amber-500" required>
                            <option value="present">حاضر ✓</option>
                            <option value="absent">غياب ✗</option>
                            <option value="half">نصف يوم 50%</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold w-full">حفظ الحضور</button>
                </form>
            </div>

            <!-- Attendance Records Table -->
            <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <h3 class="text-lg font-bold p-4 bg-slate-50 border-b">سجل الحضور</h3>
                <table class="w-full text-right">
                    <thead class="bg-slate-50 text-slate-700 border-b">
                        <tr>
                            <th class="p-4">التاريخ</th>
                            <th class="p-4">اسم الموظف</th>
                            <th class="p-4">الحالة</th>
                            <th class="p-4">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <!-- Salary Summary by Attendance -->
            <div class="mt-6 bg-gradient-to-r from-amber-50 to-yellow-50 p-6 rounded-xl shadow-sm border border-amber-200">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-calculator"></i> ملخص الراتب حسب الحضور
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-white border-b">
                            <tr>
                                <th class="p-3 font-bold">اسم الموظف</th>
                                <th class="p-3 font-bold">راتب الشهر</th>
                                <th class="p-3 font-bold">أيام العمل الكلية</th>
                                <th class="p-3 font-bold">أيام الحضور</th>
                                <th class="p-3 font-bold">أجر اليوم</th>
                                <th class="p-3 font-bold text-emerald-600">الراتب المستحق</th>
                            </tr>
                        </thead>
                        <tbody id="salary-summary-body" class="divide-y divide-amber-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Add Product -->
    <div id="add-product-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-2 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all my-4">
            <!-- Header with softer, consistent brand -->
            <div class="modal-header flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="icon-wrapper">
                        <i class="ph ph-package text-lg"></i>
                    </div>
                    <div>
                        <h3 id="product-modal-title" class="font-bold text-sm">إضافة منتج جديد</h3>
                        <p class="text-xs text-amber-100">أضف منتج</p>
                    </div>
                </div>
                <button onclick="toggleModal('add-product-modal', false)" class="hover:bg-white/20 transition p-1 rounded-lg"><i class="ph ph-x text-lg"></i></button>
            </div>
            
            <form id="product-form" onsubmit="handleAddProduct(event)" class="p-6 space-y-4 overflow-y-auto max-h-[calc(100vh-250px)]">
                <input type="hidden" id="prod-id">
                
                <!-- Basic Info Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">المعلومات الأساسية</p>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">كود المنتج</label>
                        <input required type="text" id="prod-code" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="مثال: SKU-001">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">نوع الصنف</label>
                        <input required type="text" id="prod-type" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="مثال: قميص، بنطلون">
                    </div>
                </div>
                
                <!-- Details Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">التفاصيل</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">المقاس</label>
                            <input type="text" id="prod-size" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="M, L, 40">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">اللون</label>
                            <input type="text" id="prod-color" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="أحمر، أزرق">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">الوزن (جم)</label>
                            <input type="number" id="prod-weight" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">الكمية</label>
                            <input required type="number" id="prod-qty" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <!-- Pricing Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">السعر</p>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">السعر (ج.م)</label>
                        <div class="relative">
                            <input required type="number" id="prod-price" class="w-full px-4 py-2.5 pr-8 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="0.00">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ج.م</span>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button id="product-submit-btn" type="submit" class="w-full modal-cta hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:scale-105 mt-6 flex items-center justify-center gap-2">
                    <i class="ph ph-check-circle"></i> حفظ المنتج
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Invoice Preview -->
    <div id="invoice-preview-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 overflow-y-auto no-print">
        <div id="invoice-paper" class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden relative min-h-[500px]">
            
            <div class="p-10 text-slate-900 print:p-6" dir="rtl">
                <div class="border-b-4 border-slate-800 pb-6 mb-6 flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-3">
                            <img src="100.png" alt="لوغو" class="w-12 h-12 object-contain rounded" />
                            <h1 class="text-4xl font-bold text-slate-900 mb-1">النسر جروب</h1>
                        </div>
                        <p class="text-slate-600 font-bold">لمصنوعات الملابس الجاهزة</p>
                        <p class="text-sm text-slate-500 mt-2">نسخة الفواتير الشخصية</p>
                    </div>
                    <div class="text-left">
                        <h2 class="text-2xl font-bold text-gray-300">فاتورة بيع</h2>
                        <p class="font-mono mt-2 text-lg font-bold text-slate-700" id="preview-inv-number">#INV-000000</p>
                        <p class="text-sm text-gray-500 mt-1" id="preview-inv-date">--/--/----</p>
                    </div>
                </div>

                <div class="mb-8 p-4 bg-gray-50 border-r-4 border-amber-600">
                    <p class="text-lg"><span class="font-bold text-slate-700">السيد/</span> <span id="preview-customer" class="font-bold">...</span></p>
                </div>

                <table class="w-full mb-8 text-right border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-white print:bg-gray-100 print:text-black">
                            <th class="p-3 border">م</th>
                            <th class="p-3 border">كود الصنف</th>
                            <th class="p-3 border">البيان</th>
                            <th class="p-3 border">المقاس</th>
                            <th class="p-3 border">الكمية</th>
                            <th class="p-3 border">السعر</th>
                            <th class="p-3 border">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items-body"></tbody>
                </table>

                <!-- QR Code and Total on same line -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex flex-col items-center">
                        <img src="3qr-code.png" alt="QR Code" class="w-20 h-20 object-contain border border-gray-300 p-2 bg-white" />
                        <p class="text-xs text-gray-500 mt-1 font-bold">اسكان ال qr</p>
                    </div>
                    <div class="w-1/3 bg-slate-50 p-3 border-2 border-slate-800">
                        <div class="flex justify-between items-center text-lg font-bold text-slate-900 mb-2">
                            <span>الإجمالي:</span>
                            <span id="preview-total-amount">0 ج.م</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-blue-700 mb-2">
                            <span>المدفوع:</span>
                            <span id="preview-paid-amount">0 ج.م</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-red-600 border-t pt-2">
                            <span>الرصيد:</span>
                            <span id="preview-remaining-amount">0 ج.م</span>
                        </div>
                    </div>
                </div>

                <div class="mt-20 text-center text-xs text-gray-400 print:mt-12">
                    <p>تم استخراج هذه الفاتورة بواسطة نظام النسر جروب - المخزن الشخصي</p>
                </div>
            </div>

            <!-- Action buttons on the top left -->
            <div class="absolute top-2 left-2 flex gap-2 no-print">
                <button onclick="window.print()" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-lg">
                    <i class="ph ph-printer text-lg"></i> طباعة
                </button>
                <button onclick="toggleModal('invoice-preview-modal', false)" class="bg-slate-700 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-lg">
                    <i class="ph ph-x text-lg"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Incoming -->
    <div id="add-incoming-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-2 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all my-4">
            <!-- Header with softer, consistent brand -->
            <div class="modal-header flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="icon-wrapper">
                        <i class="ph ph-truck text-lg"></i>
                    </div>
                    <div>
                        <h3 id="incoming-modal-title" class="font-bold text-sm">إضافة وارد جديد</h3>
                        <p class="text-xs text-amber-100">سجل المشتريات</p>
                    </div>
                </div>
                <button onclick="toggleModal('add-incoming-modal', false)" class="hover:bg-white/20 transition p-1 rounded-lg"><i class="ph ph-x text-lg"></i></button>
            </div>
            
                <form id="incoming-form" onsubmit="handleAddIncoming(event)" class="p-6 space-y-4 overflow-y-auto max-h-[calc(100vh-250px)]">
                <input type="hidden" id="incoming-id">
                
                <!-- Invoice Info Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">بيانات الفاتورة</p>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">كود الفاتورة</label>
                        <input required type="text" id="incoming-code" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="مثال: INV-001">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">تاريخ الفاتورة</label>
                        <input required type="text" id="incoming-date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="25/01/2026" oninput="formatArabicDate(this)">
                    </div>
                </div>
                
                <!-- Item Info Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">تفاصيل الصنف</p>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">نوع الصنف</label>
                        <input required type="text" id="incoming-item" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition" placeholder="مثال: قميص، بنطلون">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">اللون</label>
                            <input type="text" id="incoming-color" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="أحمر، أزرق">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">العدد</label>
                            <input type="number" id="incoming-quantity" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <!-- Quantity & Value Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">الكميات والقيم</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">الوزن (كيلو)</label>
                            <input type="number" step="0.01" id="incoming-weight" class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-800 mb-2">القيمة (ج.م)</label>
                            <div class="relative">
                                <input type="number" step="0.01" id="incoming-value" class="w-full px-3 py-2.5 pr-8 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none text-sm transition" placeholder="0.00">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs">ج.م</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Image Section -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">صورة الفاتورة</p>
                    <div>
                        <label class="block text-sm font-semibold text-slate-800 mb-2">اختر صورة الفاتورة</label>
                        <input type="file" id="incoming-image" accept="image/*" class="w-full px-4 py-2.5 border-2 border-dashed border-gray-300 rounded-lg focus:border-amber-500 outline-none text-xs transition cursor-pointer hover:border-amber-300" onchange="previewIncomingImage(event)">
                        <div id="incoming-image-preview" class="mt-3 hidden p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <img id="incoming-image-thumb" class="w-20 h-20 object-cover border-2 border-gray-300 rounded-lg" alt="معاينة الصورة">
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="incoming-submit-btn" class="w-full modal-cta hover:bg-amber-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:scale-105 mt-6 flex items-center justify-center gap-2">
                    <i class="ph ph-check-circle"></i> حفظ الوارد
                </button>
            </form>
        </div>
    </div>

    <!-- Core Logic -->
    <script>
        // Password System - Always require password "000"
        const DEFAULT_PASSWORD = '000';
        let isAuthenticated = false;
        const REMEMBER_DURATION = 24 * 60 * 60 * 1000; // 24 ساعة

        // Check if user is remembered on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkRememberedUser();
        });

        function checkRememberedUser() {
            const remembered = localStorage.getItem('alnasr_remembered_time');
            if (remembered) {
                const timestamp = Number(remembered);
                const now = Date.now();
                if (now - timestamp < REMEMBER_DURATION) {
                    isAuthenticated = true;
                    return; // لا تظهر نموذج كلمة المرور
                } else {
                    localStorage.removeItem('alnasr_remembered_time');
                }
            }
            showPasswordPrompt();
        }

        function showPasswordPrompt() {
            const modal = document.createElement('div');
            modal.id = 'password-prompt-modal';
            modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[999] p-3';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden">
                    <div class="bg-slate-900 text-white p-4 flex items-center gap-2">
                        <img src="100.png" alt="لوغو" class="w-9 h-9 object-contain rounded" />
                        <div>
                            <h2 class="font-bold text-base text-white">النسر جروب</h2>
                            <p class="text-xs text-slate-300">إدارة المخزن الشخصي</p>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <h3 class="text-lg font-bold text-center text-slate-900">أدخل كلمة المرور</h3>
                        <input type="password" id="password-input" placeholder="كلمة المرور" class="w-full px-3 py-2 border-2 border-amber-500 rounded-lg focus:border-amber-600 focus:ring-1 focus:ring-amber-200 outline-none text-slate-800 text-sm" onkeypress="if(event.key==='Enter') checkPassword()">
                        <div class="flex items-center gap-2 py-1">
                            <input type="checkbox" id="remember-checkbox" class="w-4 h-4 cursor-pointer">
                            <label for="remember-checkbox" class="text-slate-700 text-xs cursor-pointer">تذكرني لمدة 24 ساعة</label>
                        </div>
                        <button onclick="checkPassword()" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 rounded-lg font-bold text-sm transition">
                            دخول
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('password-input').focus();
        }

        window.checkPassword = () => {
            const password = document.getElementById('password-input').value;
            const rememberCheckbox = document.getElementById('remember-checkbox');
            
            if (password === DEFAULT_PASSWORD) {
                isAuthenticated = true;
                
                // حفظ وقت التذكر إذا كان مختاراً
                if (rememberCheckbox && rememberCheckbox.checked) {
                    localStorage.setItem('alnasr_remembered_time', Date.now().toString());
                } else {
                    localStorage.removeItem('alnasr_remembered_time');
                }
                
                const modal = document.getElementById('password-prompt-modal');
                if (modal) modal.remove();
            } else {
                alert('كلمة المرور غير صحيحة! الكلمة الصحيحة هي: 000');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        };
        // Fullscreen logic
        window.toggleFullscreen = () => {
            const el = document.documentElement;
            if (!document.fullscreenElement) {
                el.requestFullscreen();
                document.body.classList.add('fullscreen-mode');
            } else {
                document.exitFullscreen();
                document.body.classList.remove('fullscreen-mode');
            }
        };

        // Sidebar toggle for mobile
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger-btn');
            sidebar.classList.toggle('sidebar-open');
            hamburger.classList.toggle('sidebar-open-btn');
        };

        // Close sidebar when clicking on a menu item (mobile)
        function closeSidebarOnMobile() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const hamburger = document.getElementById('hamburger-btn');
                sidebar.classList.remove('sidebar-open');
                hamburger.classList.remove('sidebar-open-btn');
            }
        }

        // Close sidebar when clicking on overlay (backdrop)
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const hamburger = document.getElementById('hamburger-btn');
                
                // Check if click is outside sidebar and hamburger button
                if (sidebar && hamburger && !sidebar.contains(event.target) && !hamburger.contains(event.target)) {
                    if (sidebar.classList.contains('sidebar-open')) {
                        sidebar.classList.remove('sidebar-open');
                        hamburger.classList.remove('sidebar-open-btn');
                    }
                }
            }
        });
        // --- Storage Logic ---
        const DB_KEYS = {
            PRODUCTS: 'alnasr_products',
            INVOICES: 'alnasr_invoices',
            INCOMING: 'alnasr_incoming',
            EMPLOYEES: 'alnasr_employees',
            ATTENDANCE: 'alnasr_attendance'
        };

        let products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS)) || [];
        let invoices = JSON.parse(localStorage.getItem(DB_KEYS.INVOICES)) || [];
        let incoming = JSON.parse(localStorage.getItem(DB_KEYS.INCOMING)) || [];
        let employees = JSON.parse(localStorage.getItem(DB_KEYS.EMPLOYEES)) || [];
        let attendance = JSON.parse(localStorage.getItem(DB_KEYS.ATTENDANCE)) || [];
        let cart = [];

        function saveData() {
            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(DB_KEYS.INVOICES, JSON.stringify(invoices));
            localStorage.setItem(DB_KEYS.INCOMING, JSON.stringify(incoming));
            localStorage.setItem(DB_KEYS.EMPLOYEES, JSON.stringify(employees));
            localStorage.setItem(DB_KEYS.ATTENDANCE, JSON.stringify(attendance));
            renderAll();
        }

        // --- App Initialization ---
        window.onload = () => {
            renderAll();
            document.getElementById('inv-date-display').value = new Date().toLocaleDateString('ar-EG');
            
            // Set today's date in attendance form (Arabic format)
            const today = new Date();
            const attDateInput = document.getElementById('att-date');
            if (attDateInput) {
                attDateInput.value = formatDateToArabic(today);
            }
            
            // Adjust layout on mobile
            if (window.innerWidth <= 768) {
                const viewSections = document.querySelectorAll('.view-section');
                viewSections.forEach(section => {
                    section.style.paddingTop = '20px';
                });
            }
            
            setInterval(() => {
                document.getElementById('current-time-display').innerText = new Date().toLocaleString('ar-EG');
            }, 1000);
        };

        // Convert date to Arabic format: DD/MM/YYYY
        function formatDateToArabic(dateObj) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Parse Arabic date format DD/MM/YYYY to ISO format YYYY-MM-DD for storage
        function parseArabicDate(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const day = parts[0].trim();
            const month = parts[1].trim();
            const year = parts[2].trim();
            return `${year}-${month}-${day}`;
        }

        // Format user input for Arabic dates
        window.formatArabicDateInput = (input) => {
            let value = input.value.replace(/[^0-9/]/g, '');
            
            if (value.length === 2 && !value.includes('/')) {
                value = value + '/';
            } else if (value.length === 5 && value.split('/').length === 2) {
                value = value + '/';
            }
            
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            input.value = value;
        };

        function renderAll() {
            renderDashboard();
            renderInventoryTable();
            renderHistoryTable();
            renderIncomingTable();
            updateProductDropdown();
            renderEmployees();
            updateAttendanceDropdown();
            renderAttendanceTable();
            renderSalarySummary();
        }

        // --- Tabs Navigation ---
        window.switchTab = (tabName) => {
            // Hide all view sections
            const views = ['dashboard', 'inventory', 'invoices', 'history', 'incoming', 'employees', 'backup'];
            views.forEach(view => {
                const element = document.getElementById(`view-${view}`);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            // Reset all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600', 'text-white', 'shadow-md');
                btn.classList.add('text-slate-300', 'hover:bg-slate-800');
            });

            // Show selected view
            const selectedView = document.getElementById(`view-${tabName}`);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }

            // Activate selected button
            const selectedBtn = document.getElementById(`btn-${tabName}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
                selectedBtn.classList.add('bg-amber-600', 'text-white', 'shadow-md');
            }

            // Close sidebar on mobile
            closeSidebarOnMobile();
        };

        // --- Dashboard Logic ---
        function renderDashboard() {
            const totalStock = products.reduce((acc, p) => acc + (Number(p.quantity) || 0), 0);
            const totalValue = products.reduce((acc, p) => acc + ((Number(p.quantity) || 0) * (Number(p.price) || 0)), 0);
            const totalIncomingValue = incoming.reduce((acc, i) => acc + (Number(i.value) || 0), 0);
            const lowStock = products.filter(p => p.quantity < 5).length;
            
            document.getElementById('stat-total-stock').innerText = totalStock.toLocaleString();
            document.getElementById('stat-stock-value').innerText = totalValue.toLocaleString();
            document.getElementById('stat-incoming-value').innerText = totalIncomingValue.toLocaleString();
            document.getElementById('stat-low-stock').innerText = lowStock;

            const recentBody = document.getElementById('recent-products-table');
            recentBody.innerHTML = products.length ? '' : '<tr><td colspan="4" class="p-4 text-center text-gray-400">لا توجد بيانات</td></tr>';
            
            [...products].reverse().slice(0, 5).forEach(p => {
                const info = `${p.type || ''}${p.size ? ' - ' + p.size : ''}${p.color ? ' - ' + p.color : ''}`;
                recentBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-3 font-mono text-amber-700">${p.code}</td>
                        <td class="p-3 font-bold">${info}</td>
                        <td class="p-3">${p.quantity}</td>
                        <td class="p-3 text-emerald-600 font-bold">${p.price} ج.م</td>
                    </tr>
                `;
            });
        }

        // --- Inventory Logic ---
        window.toggleModal = (id, show) => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = show ? 'flex' : 'none';
            }
        };

        window.handleAddProduct = (e) => {
            e.preventDefault();
            const existingId = document.getElementById('prod-id').value;
            const prodData = {
                code: document.getElementById('prod-code').value,
                type: document.getElementById('prod-type').value,
                weight: document.getElementById('prod-weight').value,
                quantity: Number(document.getElementById('prod-qty').value),
                price: Number(document.getElementById('prod-price').value),
                size: document.getElementById('prod-size').value,
                color: document.getElementById('prod-color').value,
            };

            if(existingId) {
                const idx = products.findIndex(p => p.id === existingId);
                if(idx !== -1) {
                    products[idx] = { ...products[idx], ...prodData };
                    saveData();
                    e.target.reset();
                    document.getElementById('prod-id').value = '';
                    toggleModal('add-product-modal', false);
                    return;
                }
            }

            const newProduct = {
                id: Date.now().toString(),
                ...prodData,
                dateAdded: new Date().toISOString()
            };

            products.push(newProduct);
            saveData();
            e.target.reset();
            document.getElementById('prod-id').value = '';
            toggleModal('add-product-modal', false);
        };

        window.renderInventoryTable = () => {
            const term = document.getElementById('inventory-search').value.toLowerCase();
            const filtered = products.filter(p => p.code.toLowerCase().includes(term) || p.type.toLowerCase().includes(term));
            
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';

            filtered.forEach(p => {
                const isLow = p.quantity < 5;
                const infoHTML = `
                    <span class="font-bold">${p.type || ''}</span>
                    ${p.size ? `<div class="text-xs text-gray-500 mt-0.5">المقاس: ${p.size}</div>` : ''}
                    ${p.color ? `<div class="text-xs text-gray-500 mt-0.5">اللون: ${p.color}</div>` : ''}
                `;
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 border-b transition">
                        <td class="p-3 font-mono font-bold text-amber-700 text-xs">${p.code}</td>
                        <td class="p-3 text-xs">${infoHTML}</td>
                        <td class="p-3 text-gray-600 text-xs hidden-mobile">${p.weight || '0'}g</td>
                        <td class="p-3 font-bold text-sm">${p.price}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs font-bold ${isLow ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                                ${p.quantity}
                            </span>
                        </td>
                        <td class="p-3 flex gap-1 justify-center">
                            <button onclick="editProduct('${p.id}')" class="text-blue-600 hover:text-blue-800 transition bg-blue-50 hover:bg-blue-100 p-2 rounded" title="تعديل">
                                <i class="ph ph-pencil text-sm"></i>
                            </button>
                            <button onclick="deleteProduct('${p.id}')" class="text-red-600 hover:text-red-800 transition bg-red-50 hover:bg-red-100 p-2 rounded" title="حذف">
                                <i class="ph ph-trash text-sm"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        };

        window.deleteProduct = (id) => {
            if(confirm('هل تريد حذف هذا الصنف من جهازك؟')) {
                products = products.filter(p => p.id !== id);
                saveData();
            }
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-code').value = p.code || '';
            document.getElementById('prod-type').value = p.type || '';
            document.getElementById('prod-weight').value = p.weight || '';
            document.getElementById('prod-qty').value = p.quantity || 0;
            document.getElementById('prod-price').value = p.price || '';
            document.getElementById('prod-size').value = p.size || '';
            document.getElementById('prod-color').value = p.color || '';
            // Update modal title and submit button for edit mode
            const titleEl = document.getElementById('product-modal-title');
            if(titleEl) titleEl.innerText = 'تعديل المنتج';
            const submitBtn = document.getElementById('product-submit-btn');
            if(submitBtn) submitBtn.innerText = 'حفظ التعديل';
            toggleModal('add-product-modal', true);
        };

        // Reset product form for add-new flow
        window.resetProductForm = () => {
            const form = document.getElementById('product-form');
            if(form) form.reset();
            const idEl = document.getElementById('prod-id');
            if(idEl) idEl.value = '';
            const titleEl = document.getElementById('product-modal-title');
            if(titleEl) titleEl.innerText = 'إضافة منتج جديد';
            const submitBtn = document.getElementById('product-submit-btn');
            if(submitBtn) submitBtn.innerText = 'حفظ المنتج';
        };

        // --- Invoice Logic ---
        function updateProductDropdown() {
            const select = document.getElementById('inv-product-select');
            select.innerHTML = '<option value="">-- اختر صنف --</option>';
            products.forEach(p => {
                if(p.quantity > 0) {
                    const extra = `${p.size ? ' - ' + p.size : ''}${p.color ? ' - ' + p.color : ''}`;
                    select.innerHTML += `<option value="${p.id}">${p.code} - ${p.type}${extra} (متاح: ${p.quantity})</option>`;
                }
            });
        }

        window.addToCart = () => {
            const productId = document.getElementById('inv-product-select').value;
            const qty = Number(document.getElementById('inv-qty').value);
            
            if(!productId || qty < 1) return;
            const product = products.find(p => p.id === productId);

            if(qty > product.quantity) {
                alert('الكمية المطلوبة غير متوفرة في المخزن!');
                return;
            }

            const existing = cart.find(c => c.id === productId);
            if(existing) {
                existing.sellQuantity += qty;
                existing.total = existing.sellQuantity * existing.price;
            } else {
                cart.push({ ...product, sellQuantity: qty, total: qty * product.price });
            }
            
            renderCart();
        };

        window.removeFromCart = (idx) => {
            cart.splice(idx, 1);
            renderCart();
        };

        function renderCart() {
            const tbody = document.getElementById('cart-table-body');
            tbody.innerHTML = cart.length ? '' : '<tr><td colspan="7" class="p-4 text-center text-gray-400">لم تضف أصناف بعد</td></tr>';
            
            let total = 0;
            cart.forEach((item, idx) => {
                total += item.total;
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-mono">${item.code}</td>
                        <td class="p-3">${item.type || ''}</td>
                        <td class="p-3">${item.size || '-'}</td>
                        <td class="p-3 font-bold">${item.sellQuantity}</td>
                        <td class="p-3">${item.price}</td>
                        <td class="p-3 font-bold text-emerald-600">${item.total}</td>
                        <td class="p-3"><button onclick="removeFromCart(${idx})" class="text-red-500"><i class="ph ph-trash"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('summary-count').innerText = cart.length;
            document.getElementById('summary-total').innerText = total + ' ج.م';
            document.getElementById('btn-save-invoice').disabled = cart.length === 0;
            document.getElementById('btn-print-now').disabled = cart.length === 0;
            updateRemainingBalance();
        }

        // حساب الرصيد المتبقي
        function updateRemainingBalance() {
            const totalElement = document.getElementById('summary-total');
            const paidInput = document.getElementById('inv-paid-amount');
            const balanceElement = document.getElementById('remaining-balance');
            
            const totalText = totalElement.innerText.replace(' ج.م', '');
            const total = Number(totalText) || 0;
            const paid = Number(paidInput.value) || 0;
            const remaining = total - paid;
            
            if (remaining > 0) {
                balanceElement.innerText = remaining + ' ج.م';
                balanceElement.className = 'font-bold text-red-600 text-xl';
            } else if (remaining === 0) {
                balanceElement.innerText = 'تم السداد كاملاً ✓';
                balanceElement.className = 'font-bold text-green-600 text-xl';
            } else {
                balanceElement.innerText = Math.abs(remaining) + ' ج.م (رصيد)';
                balanceElement.className = 'font-bold text-blue-600 text-xl';
            }
        }

        // --- Incoming Logic ---
        window.previewIncomingImage = (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('incoming-image-preview');
            const thumb = document.getElementById('incoming-image-thumb');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    thumb.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        };

        window.handleAddIncoming = (e) => {
            e.preventDefault();
            const existingId = document.getElementById('incoming-id').value;
            
            // Handle image file
            const imageFile = document.getElementById('incoming-image').files[0];
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveIncomingData(existingId, e.target.result);
                };
                reader.readAsDataURL(imageFile);
            } else {
                // If no new image selected, keep the existing image
                const existingItem = existingId ? incoming.find(i => i.id === existingId) : null;
                const existingImage = existingItem ? existingItem.image : '';
                saveIncomingData(existingId, existingImage);
            }
        };

        function saveIncomingData(existingId, imageData) {
            const incomingData = {
                code: document.getElementById('incoming-code').value,
                date: document.getElementById('incoming-date').value,
                item: document.getElementById('incoming-item').value,
                color: document.getElementById('incoming-color').value,
                quantity: document.getElementById('incoming-quantity').value,
                weight: document.getElementById('incoming-weight').value,
                value: document.getElementById('incoming-value').value,
                image: imageData,
            };

            if(existingId) {
                const idx = incoming.findIndex(i => i.id === existingId);
                if(idx !== -1) {
                    incoming[idx] = { ...incoming[idx], ...incomingData };
                    saveData();
                    showNotification('تم حفظ التعديلات بنجاح!');
                    resetIncomingForm();
                    return;
                }
            }

            const newIncoming = {
                id: Date.now().toString(),
                ...incomingData,
                dateAdded: new Date().toISOString()
            };

            incoming.push(newIncoming);
            saveData();
            showNotification('تم إضافة الوارد بنجاح!');
            resetIncomingForm();
        }

        window.resetIncomingForm = () => {
            document.getElementById('incoming-form').reset();
            document.getElementById('incoming-id').value = '';
            document.getElementById('incoming-image-preview').classList.add('hidden');
            
            // Reset modal title and button text for adding new
            document.getElementById('incoming-modal-title').innerText = 'إضافة وارد جديد';
            document.getElementById('incoming-submit-btn').innerText = 'حفظ الوارد';
            
            toggleModal('add-incoming-modal', false);
        };

        function renderIncomingTable() {
            const tbody = document.getElementById('incoming-table-body');
            tbody.innerHTML = incoming.length ? '' : '<tr><td colspan="9" class="p-4 text-center text-gray-400">لا توجد بيانات وارد</td></tr>';
            
            [...incoming].reverse().forEach(item => {
                const date = new Date(item.date);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                const arabicDate = `${day}/${month}/${year}`;
                
                const imageCell = item.image ? 
                    `<img src="${item.image}" class="w-12 h-12 object-cover border rounded cursor-pointer" onclick="showFullImage('${item.image}')" alt="صورة الفاتورة">` : 
                    '-';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b transition">
                        <td class="p-4 font-mono font-bold text-amber-700">${item.code}</td>
                        <td class="p-4 text-sm font-mono">${arabicDate}</td>
                        <td class="p-4 font-bold">${item.item}</td>
                        <td class="p-4">${item.color || '-'}</td>
                        <td class="p-4">${item.quantity || '-'}</td>
                        <td class="p-4">${item.weight || '-'} كيلو</td>
                        <td class="p-4 font-bold text-emerald-600">${item.value ? Number(item.value).toLocaleString() + ' ج.م' : '-'}</td>
                        <td class="p-4 text-center">${imageCell}</td>
                        <td class="p-4 flex gap-2">
                            <button onclick="editIncoming('${item.id}')" class="bg-blue-50 text-blue-600 p-1.5 rounded hover:bg-blue-100 transition" title="تعديل">
                                <i class="ph ph-pencil text-lg"></i>
                            </button>
                            <button onclick="deleteIncoming('${item.id}')" class="bg-red-50 text-red-500 p-1.5 rounded hover:bg-red-100 transition" title="حذف">
                                <i class="ph ph-trash text-lg"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        window.showFullImage = (imageSrc) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[999] p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <img id="full-image" src="${imageSrc}" class="max-w-full max-h-full object-contain transition-transform duration-300" alt="صورة الفاتورة" style="transform: scale(1);">
                    
                    <!-- Zoom Controls -->
                    <div class="absolute top-4 left-4 flex gap-2">
                        <button onclick="zoomImage(0.2)" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition shadow-lg" title="تكبير الصورة">
                            <i class="ph ph-plus text-lg"></i>
                        </button>
                        <button onclick="zoomImage(-0.2)" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition shadow-lg" title="تصغير الصورة">
                            <i class="ph ph-minus text-lg"></i>
                        </button>
                        <button onclick="resetZoom()" class="bg-gray-500 text-white p-2 rounded-full hover:bg-gray-600 transition shadow-lg" title="إعادة تعيين الحجم">
                            <i class="ph ph-arrow-clockwise text-lg"></i>
                        </button>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.formatArabicDate = (input) => {
            // Remove any non-numeric characters except /
            let value = input.value.replace(/[^0-9/]/g, '');
            
            // Auto-format as dd/mm/yyyy
            if (value.length === 2 && !value.includes('/')) {
                value = value + '/';
            } else if (value.length === 5 && value.split('/').length === 2) {
                value = value + '/';
            }
            
            // Limit to 10 characters (dd/mm/yyyy)
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            input.value = value;
        };

        // Notification function
        window.showNotification = (message, type = 'success') => {
            const toast = document.getElementById('notification-toast');
            const messageEl = document.getElementById('notification-message');
            
            messageEl.textContent = message;
            
            // Set color based on type
            if (type === 'success') {
                toast.className = toast.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else if (type === 'error') {
                toast.className = toast.className.replace(/bg-\w+-500/, 'bg-red-500');
            }
            
            // Show toast
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100', 'pointer-events-auto');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'pointer-events-auto');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        };

        window.editIncoming = (id) => {
            const item = incoming.find(i => i.id === id);
            if(!item) return;
            
            document.getElementById('incoming-id').value = item.id;
            document.getElementById('incoming-code').value = item.code || '';
            document.getElementById('incoming-date').value = item.date || '';
            document.getElementById('incoming-item').value = item.item || '';
            document.getElementById('incoming-color').value = item.color || '';
            document.getElementById('incoming-quantity').value = item.quantity || '';
            document.getElementById('incoming-weight').value = item.weight || '';
            document.getElementById('incoming-value').value = item.value || '';
            
            // Update modal title and button text for editing
            document.getElementById('incoming-modal-title').innerText = 'تعديل الوارد';
            document.getElementById('incoming-submit-btn').innerText = 'حفظ التعديلات';
            
            // Handle image preview for editing
            const preview = document.getElementById('incoming-image-preview');
            const thumb = document.getElementById('incoming-image-thumb');
            if (item.image) {
                thumb.src = item.image;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
            
            toggleModal('add-incoming-modal', true);
        };

        window.deleteIncoming = (id) => {
            if(confirm('هل تريد حذف هذا الوارد من جهازك؟')) {
                incoming = incoming.filter(i => i.id !== id);
                saveData();
            }
        };

        window.saveInvoice = () => {
            const customer = document.getElementById('inv-customer-name').value || 'عميل نقدي';
            const total = cart.reduce((s, i) => s + i.total, 0);
            const paidAmount = Number(document.getElementById('inv-paid-amount').value) || 0;
            const remainingBalance = total - paidAmount;
            
            const newInvoice = {
                id: Date.now().toString(),
                invoiceNumber: 'INV-' + Math.floor(1000 + Math.random() * 9000),
                date: new Date().toISOString(),
                customerName: customer,
                items: [...cart],
                totalAmount: total,
                paidAmount: paidAmount,
                remainingBalance: remainingBalance
            };

            // Update stock
            cart.forEach(item => {
                const pIdx = products.findIndex(p => p.id === item.id);
                if(pIdx !== -1) products[pIdx].quantity -= item.sellQuantity;
            });

            invoices.push(newInvoice);
            saveData();
            
            // Preview & Reset
            openPreview(newInvoice);
            cart = [];
            document.getElementById('inv-customer-name').value = '';
            document.getElementById('inv-paid-amount').value = '0';
            renderCart();
        };

        // Print current cart as an invoice preview without saving
        window.printInvoiceNow = () => {
            if(cart.length === 0) return alert('لا توجد منتجات للطباعة.');
            const customer = document.getElementById('inv-customer-name').value || 'عميل نقدي';
            const total = cart.reduce((s, i) => s + i.total, 0);
            const tempInv = {
                id: 'preview-' + Date.now().toString(),
                invoiceNumber: 'INV-PREVIEW-' + Math.floor(1000 + Math.random() * 9000),
                date: new Date().toISOString(),
                customerName: customer,
                items: [...cart],
                totalAmount: total
            };
            openPreview(tempInv);
            // allow modal to render then trigger print
            setTimeout(() => window.print(), 300);
        };

        // --- History & Reprint ---
        window.renderHistoryTable = () => {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            [...invoices].reverse().forEach(inv => {
                const remaining = (inv.remainingBalance !== undefined) ? inv.remainingBalance : (inv.totalAmount - 0);
                const paid = (inv.paidAmount !== undefined) ? inv.paidAmount : 0;
                const balanceClass = remaining > 0 ? 'text-red-600 font-bold' : remaining === 0 ? 'text-green-600 font-bold' : 'text-blue-600 font-bold';
                const balanceText = remaining > 0 ? `${remaining} ج.م` : remaining === 0 ? 'مدفوع ✓' : `${Math.abs(remaining)} رصيد`;
                
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 border-b transition">
                        <td class="p-3 font-mono font-bold text-amber-700 text-xs">${inv.invoiceNumber}</td>
                        <td class="p-3 text-xs">${new Date(inv.date).toLocaleDateString('ar-EG')}</td>
                        <td class="p-3 font-bold text-xs">${inv.customerName}</td>
                        <td class="p-3 text-xs font-bold hidden-mobile">${inv.items.length}</td>
                        <td class="p-3 font-bold text-emerald-600 text-xs">${inv.totalAmount}</td>
                        <td class="p-3 font-bold text-blue-700 text-xs hidden-mobile">${paid}</td>
                        <td class="p-3 text-xs ${balanceClass}">${balanceText}</td>
                        <td class="p-3 flex gap-0.5 justify-center flex-wrap">
                            <button onclick="reprint('${inv.id}')" title="طباعة" class="bg-blue-600 text-white rounded hover:bg-blue-700 transition" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"><i class="ph ph-printer text-base"></i></button>
                            <button onclick="editPayment('${inv.id}')" title="تعديل" class="bg-amber-600 text-white rounded hover:bg-amber-700 transition" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"><i class="ph ph-pencil text-base"></i></button>
                            <button onclick="deleteInvoice('${inv.id}')" title="حذف" class="bg-red-600 text-white rounded hover:bg-red-700 transition" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"><i class="ph ph-trash text-base"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.reprint = (id) => {
            const inv = invoices.find(i => i.id === id);
            if(inv) openPreview(inv);
        };

        window.editPayment = (id) => {
            const inv = invoices.find(i => i.id === id);
            if(!inv) return alert('الفاتورة غير موجودة');
            
            const newPaid = prompt(`الفاتورة: ${inv.invoiceNumber}\nالإجمالي: ${inv.totalAmount} ج.م\nالمدفوع حالياً: ${inv.paidAmount || 0} ج.م\n\nأدخل المبلغ المدفوع الجديد:`, inv.paidAmount || 0);
            
            if(newPaid !== null) {
                const amount = Number(newPaid);
                if(isNaN(amount) || amount < 0) {
                    return alert('المبلغ غير صحيح');
                }
                inv.paidAmount = amount;
                inv.remainingBalance = inv.totalAmount - amount;
                saveData();
                renderHistoryTable();
                alert(`تم تحديث الدفع\nالمدفوع: ${amount} ج.م\nالرصيد المتبقي: ${inv.remainingBalance} ج.م`);
            }
        };

        window.deleteInvoice = (id) => {
            if(confirm('حذف سجل هذه الفاتورة من جهازك؟')) {
                invoices = invoices.filter(i => i.id !== id);
                saveData();
                renderHistoryTable();
            }
        };

        function openPreview(inv) {
            document.getElementById('preview-inv-number').innerText = inv.invoiceNumber;
            document.getElementById('preview-inv-date').innerText = new Date(inv.date).toLocaleDateString('ar-EG');
            document.getElementById('preview-customer').innerText = inv.customerName;
            document.getElementById('preview-total-amount').innerText = inv.totalAmount + ' ج.م';
            
            const paidAmount = inv.paidAmount || 0;
            const remainingBalance = inv.remainingBalance !== undefined ? inv.remainingBalance : (inv.totalAmount - paidAmount);
            
            document.getElementById('preview-paid-amount').innerText = paidAmount + ' ج.م';
            document.getElementById('preview-remaining-amount').innerText = remainingBalance + ' ج.م';
            
            const tbody = document.getElementById('preview-items-body');
            tbody.innerHTML = '';
            inv.items.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td class="p-2 border text-center">${idx + 1}</td>
                        <td class="p-2 border font-mono">${item.code}</td>
                        <td class="p-2 border">${item.type || ''}</td>
                        <td class="p-2 border text-center">${item.size || '-'}</td>
                        <td class="p-2 border text-center">${item.sellQuantity}</td>
                        <td class="p-2 border text-center">${item.price}</td>
                        <td class="p-2 border text-center font-bold">${item.total}</td>
                    </tr>
                `;
            });

            toggleModal('invoice-preview-modal', true);
        }

        // Data Export/Import functions
        // --- Employees Logic ---
        function countSundaysInMonth(year, monthIndex) {
            let d = new Date(year, monthIndex, 1);
            let sundays = 0;
            while (d.getMonth() === monthIndex) {
                if (d.getDay() === 0) sundays++;
                d.setDate(d.getDate() + 1);
            }
            return sundays;
        }

        function workingDaysInMonth(year, monthIndex) {
            const totalDays = new Date(year, monthIndex + 1, 0).getDate();
            return totalDays - countSundaysInMonth(year, monthIndex);
        }

        function calculateDailyRate(monthlySalary, year, monthIndex) {
            const wd = workingDaysInMonth(year, monthIndex);
            if (!wd) return 0;
            return Number(monthlySalary) / wd;
        }

        window.calculateDailyForForm = () => {
            const monthVal = document.getElementById('emp-month').value;
            const monthly = Number(document.getElementById('emp-monthly').value || 0);
            let year, monthIndex;
            if (monthVal) {
                const parts = monthVal.split('-');
                year = parseInt(parts[0], 10);
                monthIndex = parseInt(parts[1], 10) - 1;
            } else {
                const now = new Date();
                year = now.getFullYear();
                monthIndex = now.getMonth();
                document.getElementById('emp-month').value = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
            }

            const days = workingDaysInMonth(year, monthIndex);
            const daily = calculateDailyRate(monthly, year, monthIndex);

            document.getElementById('emp-working-days').value = days + ' يوم';
            document.getElementById('emp-daily-rate').value = daily ? daily.toFixed(2) + ' ج.م' : '0 ج.م';
        };

        window.resetEmployeeForm = () => {
            document.getElementById('employee-form').reset();
            document.getElementById('emp-id').value = '';
            document.getElementById('emp-working-days').value = '';
            document.getElementById('emp-daily-rate').value = '';
            const submitBtn = document.getElementById('employee-submit-btn');
            if (submitBtn) submitBtn.innerText = 'حفظ الموظف';
        };

        window.handleEmployeeForm = (e) => {
            e.preventDefault();
            const id = document.getElementById('emp-id').value;
            const name = document.getElementById('emp-name').value.trim();
            const phone = document.getElementById('emp-phone').value.trim();
            const monthly = Number(document.getElementById('emp-monthly').value || 0);
            const monthVal = document.getElementById('emp-month').value;

            let year, monthIndex;
            if (monthVal) {
                const parts = monthVal.split('-');
                year = parseInt(parts[0], 10);
                monthIndex = parseInt(parts[1], 10) - 1;
            } else {
                const now = new Date();
                year = now.getFullYear();
                monthIndex = now.getMonth();
            }

            const days = workingDaysInMonth(year, monthIndex);
            const daily = calculateDailyRate(monthly, year, monthIndex);

            if (id) {
                const idx = employees.findIndex(x => x.id === id);
                if (idx !== -1) {
                    employees[idx] = { ...employees[idx], name, phone, monthly, calcMonth: monthVal, workingDays: days, dailyRate: daily };
                    saveData();
                    showNotification('تم تحديث بيانات الموظف');
                    resetEmployeeForm();
                    return;
                }
            }

            const emp = {
                id: Date.now().toString(),
                name,
                phone,
                monthly,
                calcMonth: monthVal,
                workingDays: days,
                dailyRate: daily
            };

            employees.push(emp);
            saveData();
            showNotification('تم حفظ الموظف بنجاح');
            resetEmployeeForm();
        };

        function renderEmployees() {
            const tbody = document.getElementById('employees-table-body');
            if(!tbody) return;
            tbody.innerHTML = employees.length ? '' : '<tr><td colspan="5" class="p-4 text-center text-gray-400">لا يوجد موظفين</td></tr>';

            employees.forEach(emp => {
                const displayRate = emp.dailyRate ? Number(emp.dailyRate).toLocaleString() + ' ج.م' : '-';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4 font-bold">${emp.name}</td>
                        <td class="p-4">${emp.phone}</td>
                        <td class="p-4 font-bold">${emp.monthly}</td>
                        <td class="p-4 font-bold text-emerald-600">${displayRate}</td>
                        <td class="p-4 flex gap-2">
                            <button onclick="editEmployee('${emp.id}')" class="text-sky-500 hover:text-sky-700"><i class="ph ph-pencil text-lg"></i></button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:text-red-700"><i class="ph ph-trash text-lg"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        window.deleteEmployee = (id) => {
            if (confirm('هل تريد حذف هذا الموظف من جهازك؟')) {
                employees = employees.filter(e => e.id !== id);
                saveData();
                showNotification('تم حذف الموظف');
            }
        };

        window.editEmployee = (id) => {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;

            // Switch to employees tab so the form is visible on any screen
            if (window.switchTab) switchTab('employees');

            // Populate form
            document.getElementById('emp-id').value = emp.id;
            document.getElementById('emp-name').value = emp.name || '';
            document.getElementById('emp-phone').value = emp.phone || '';
            document.getElementById('emp-monthly').value = emp.monthly || '';
            if (emp.calcMonth) document.getElementById('emp-month').value = emp.calcMonth;
            document.getElementById('emp-working-days').value = emp.workingDays ? emp.workingDays + ' يوم' : '';
            document.getElementById('emp-daily-rate').value = emp.dailyRate ? Number(emp.dailyRate).toFixed(2) + ' ج.م' : '';

            // Focus first input for quick editing and set submit button text
            const nameInput = document.getElementById('emp-name');
            if (nameInput) {
                nameInput.focus();
                nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            const submitBtn = document.getElementById('employee-submit-btn');
            if (submitBtn) submitBtn.innerText = 'حفظ التعديل';
        };
        window.exportData = async () => {
            const data = {
                products: products,
                invoices: invoices,
                incoming: incoming,
                employees: employees,
                attendance: attendance,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const filename = `نسخة_احتياطية_النسر_جروب_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.json`;
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            // Try Web Share API with file support (best on modern mobile browsers)
            try {
                const file = new File([dataBlob], filename, { type: 'application/json' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: filename, text: 'نسخة احتياطية من النسر جروب' });
                    showNotification('تم مشاركة النسخة الاحتياطية عبر تطبيق المشاركة');
                    return;
                }
            } catch (err) {
                // ignore - fallbacks below
                console.warn('Web Share API (files) not available or failed', err);
            }

            // Try standard download (anchor) — works on many browsers but may be blocked in PWAs / iOS
            try {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show a helpful message and a fallback in case the browser didn't save the file
                showNotification('إن حاول المتصفح تنزيل الملف ولم يتم الحفظ، افتح خيار المشاركة أو انسخ النص يدويًا.');

                // Also open fallback UI so user can copy/share manually if download wasn't allowed
                showBackupFallback(dataStr, filename);
                return;
            } catch (err) {
                console.warn('Anchor download method failed', err);
            }

            // As last resort present the JSON for manual copy/share
            showBackupFallback(dataStr, filename);
        };

        // Show a small modal with the JSON content and quick actions for mobile users
        window.showBackupFallback = (dataStr, filename) => {
            let modal = document.getElementById('backup-fallback-modal');
            if (!modal) return;
            const textarea = modal.querySelector('textarea');
            const nameEl = modal.querySelector('.backup-filename');
            if (textarea) textarea.value = dataStr;
            if (nameEl) nameEl.innerText = filename;
            modal.classList.remove('hidden');
        };

        window.copyBackupToClipboard = async () => {
            const modal = document.getElementById('backup-fallback-modal');
            const textarea = modal.querySelector('textarea');
            try {
                await navigator.clipboard.writeText(textarea.value);
                showNotification('تم نسخ محتوى النسخة الاحتياطية للحافظة');
            } catch (err) {
                alert('نسخ فشل — يرجى تحديد النص ونسخه يدوياً.');
            }
        };

        window.openBackupInNewTab = () => {
            const modal = document.getElementById('backup-fallback-modal');
            const textarea = modal.querySelector('textarea');
            const blob = new Blob([textarea.value], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        };

        // Attempt to share file via share sheet (Drive may appear as a target on Android)
        window.shareToDriveOrShareSheet = async () => {
            const modal = document.getElementById('backup-fallback-modal');
            const textarea = modal.querySelector('textarea');
            const filename = modal.querySelector('.backup-filename').innerText || 'backup.json';
            const blob = new Blob([textarea.value], { type: 'application/json' });
            try {
                const file = new File([blob], filename, { type: 'application/json' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: filename, text: 'نسخة احتياطية من النسر جروب' });
                    showNotification('استخدم خيار "حفظ في Drive" إن ظهر في قائمة المشاركة');
                    return;
                }
            } catch (err) {
                console.warn('Share (files) failed', err);
            }
            // fallback: download and open Drive
            downloadAndOpenDrive();
        };

        // Download the JSON and open Google Drive so the user can upload the file manually
        window.downloadAndOpenDrive = () => {
            const modal = document.getElementById('backup-fallback-modal');
            const textarea = modal.querySelector('textarea');
            const filename = modal.querySelector('.backup-filename').innerText || `نسخة_احتياطية_${new Date().toLocaleDateString('ar-EG')}.json`;
            const blob = new Blob([textarea.value], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('تم تنزيل الملف. سيتم فتح Google Drive لرفع الملف.');
            window.open('https://drive.google.com/drive/my-drive', '_blank');
        };

        window.shareBackupText = async () => {
            const modal = document.getElementById('backup-fallback-modal');
            const textarea = modal.querySelector('textarea');
            const text = textarea.value;
            try {
                if (navigator.share) {
                    await navigator.share({ title: 'نسخة احتياطية - النسر جروب', text });
                    showNotification('تمت مشاركة النص');
                } else {
                    alert('ميزة المشاركة غير مدعومة على متصفحك. يمكنك نسخ النص يدوياً.');
                }
            } catch (err) {
                console.warn('Share text failed', err);
                alert('المشاركة فشلت. الرجاء نسخ النص ومشاركته يدوياً.');
            }
        };

        window.closeBackupFallback = () => {
            const modal = document.getElementById('backup-fallback-modal');
            if (modal) modal.classList.add('hidden');
        };

        // Helper: open a URL in external browser when running as standalone (PWA) or just open new tab otherwise
        function isInStandaloneMode() {
            return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        }

        async function openInExternalBrowser(url) {
            // If not in standalone, normal new tab will work
            if (!isInStandaloneMode()) {
                window.open(url, '_blank', 'noopener');
                return;
            }

            // Ask the user before attempting to leave the app
            const ok = confirm('سيتم فتح متصفح خارجي لتمكين التحميل والرفع. هل تريد المتابعة؟');
            if (!ok) return;

            // Try anchor click with target=_blank + rel=noopener
            try {
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                a.remove();

                // On Android attempt intent fallback to force Chrome
                if (/Android/i.test(navigator.userAgent)) {
                    const intentUrl = url.replace(/^https?:\/\//, 'intent://') + '#Intent;scheme=https;package=com.android.chrome;end';
                    setTimeout(() => { window.location.href = intentUrl; }, 600);
                }

                showNotification('تم محاولة فتح المتصفح الخارجي. إذا لم يفتح، استخدم زر المشاركة أو افتح المتصفح يدوياً.');
                return;
            } catch (err) {
                console.warn('openInExternalBrowser failed', err);
            }

            // Fallback: open in same window
            window.location.href = url;
        }

        // Download the JSON content then open Google Drive in external browser
        window.downloadAndOpenGoogle = () => {
            const modal = document.getElementById('backup-fallback-modal');
            if (!modal) return;
            const textarea = modal.querySelector('textarea');
            const filename = modal.querySelector('.backup-filename').innerText || `نسخة_احتياطية_${new Date().toLocaleDateString('ar-EG')}.json`;
            const blob = new Blob([textarea.value], { type: 'application/json' });

            // Trigger download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('تم تنزيل الملف. سيتم فتح Google Drive في متصفح خارجي لرفع الملف يدوياً.');
            openInExternalBrowser('https://drive.google.com/drive/my-drive');
        };


        window.importData = () => {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('يرجى اختيار ملف النسخة الاحتياطية', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (data.products && data.invoices && data.incoming) {
                        // Confirm import
                        if (confirm('هل تريد استبدال جميع البيانات الحالية بالبيانات من الملف المختار؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                            products = data.products || [];
                            invoices = data.invoices || [];
                            incoming = data.incoming || [];
                            
                            saveData();
                            showNotification('تم استيراد البيانات بنجاح!');
                        }
                    } else {
                        showNotification('ملف النسخة الاحتياطية غير صالح', 'error');
                    }
                } catch (error) {
                    showNotification('خطأ في قراءة ملف النسخة الاحتياطية', 'error');
                }
            };
            reader.readAsText(file);
        };

        window.clearAllData = () => {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه وسيحذف جميع المنتجات والفواتير والبيانات الواردة.')) {
                if (confirm('تأكيد نهائي: هل تريد بالفعل مسح جميع البيانات؟')) {
                    products = [];
                    invoices = [];
                    incoming = [];
                    saveData();
                    showNotification('تم مسح جميع البيانات بنجاح!');
                    toggleModal('settings-modal', false);
                }
            }
        };

        // Notification function
        window.showNotification = (message, type = 'success') => {
            const toast = document.getElementById('notification-toast');
            const messageEl = document.getElementById('notification-message');
            
            messageEl.textContent = message;
            
            // Set color based on type
            if (type === 'success') {
                toast.className = toast.className.replace(/bg-\w+-500/, 'bg-green-500');
            } else if (type === 'error') {
                toast.className = toast.className.replace(/bg-\w+-500/, 'bg-red-500');
            }
            
            // Show toast
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100', 'pointer-events-auto');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'pointer-events-auto');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        };

        // --- Attendance Logic ---
        function updateAttendanceDropdown() {
            const select = document.getElementById('att-employee');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- اختر موظف --</option>';
            employees.forEach(emp => {
                select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
            });
            select.value = currentValue;
        }

        window.handleAttendanceForm = (e) => {
            e.preventDefault();
            const empId = document.getElementById('att-employee').value;
            const dateStr = document.getElementById('att-date').value; // Arabic format DD/MM/YYYY
            const status = document.getElementById('att-status').value;

            if (!empId || !dateStr || !status) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }

            const dateISO = parseArabicDate(dateStr);
            if (!dateISO) {
                showNotification('صيغة التاريخ غير صحيحة. استخدم DD/MM/YYYY', 'error');
                return;
            }

            const emp = employees.find(x => x.id === empId);
            if (!emp) return;

            // Check if record already exists for this date/employee
            const existingIdx = attendance.findIndex(a => a.empId === empId && a.date === dateISO);
            if (existingIdx !== -1) {
                attendance[existingIdx] = { ...attendance[existingIdx], status, updatedAt: new Date().toISOString() };
                showNotification('تم تحديث الحضور');
            } else {
                attendance.push({
                    id: Date.now().toString(),
                    empId,
                    empName: emp.name,
                    date: dateISO,
                    status,
                    createdAt: new Date().toISOString()
                });
                showNotification('تم حفظ الحضور بنجاح');
            }

            saveData();
            document.getElementById('attendance-form').reset();
            const today = new Date();
            document.getElementById('att-date').value = formatDateToArabic(today);
        };

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendance-table-body');
            if (!tbody) return;
            tbody.innerHTML = attendance.length ? '' : '<tr><td colspan="4" class="p-4 text-center text-gray-400">لا توجد سجلات حضور</td></tr>';

            const statusMap = { present: 'حاضر ✓', absent: 'غياب ✗', half: 'نصف يوم 50%' };
            const statusColors = { present: 'bg-green-100 text-green-700', absent: 'bg-red-100 text-red-700', half: 'bg-yellow-100 text-yellow-700' };

            [...attendance].reverse().forEach(att => {
                // Convert ISO YYYY-MM-DD to Arabic DD/MM/YYYY for display
                let displayDate = att.date;
                const parts = (att.date || '').split('-');
                if (parts.length === 3) {
                    displayDate = `${String(parts[2]).padStart(2, '0')}/${String(parts[1]).padStart(2, '0')}/${parts[0]}`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4">${displayDate}</td>
                        <td class="p-4 font-bold">${att.empName}</td>
                        <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusColors[att.status]}">${statusMap[att.status]}</span></td>
                        <td class="p-4"><button onclick="deleteAttendance('${att.id}')" class="text-red-500 hover:text-red-700"><i class="ph ph-trash text-lg"></i></button></td>
                    </tr>
                `;
            });
        }

        window.deleteAttendance = (id) => {
            if (confirm('هل تريد حذف هذا السجل؟')) {
                attendance = attendance.filter(a => a.id !== id);
                saveData();
                showNotification('تم حذف السجل');
            }
        };

        function calculateAttendanceDays(empId, calcMonth) {
            if (!calcMonth) {
                const now = new Date();
                calcMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            const year = parseInt(calcMonth.split('-')[0]);
            const month = parseInt(calcMonth.split('-')[1]) - 1;

            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);

            let presentDays = 0;
            attendance.forEach(att => {
                if (att.empId === empId) {
                    // Parse ISO YYYY-MM-DD safely to avoid timezone issues
                    const parts = att.date.split('-');
                    if (parts.length !== 3) return;
                    const aYear = parseInt(parts[0], 10);
                    const aMonth = parseInt(parts[1], 10) - 1;
                    const aDay = parseInt(parts[2], 10);
                    const attDate = new Date(aYear, aMonth, aDay);

                    if (attDate >= monthStart && attDate <= monthEnd) {
                        if (att.status === 'present') presentDays += 1;
                        else if (att.status === 'half') presentDays += 0.5;
                    }
                }
            });

            return presentDays;
        }

        function renderSalarySummary() {
            const tbody = document.getElementById('salary-summary-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">لا يوجد موظفين</td></tr>';
                return;
            }

            employees.forEach(emp => {
                const now = new Date();
                const calcMonth = emp.calcMonth || `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                const year = parseInt(calcMonth.split('-')[0]);
                const month = parseInt(calcMonth.split('-')[1]) - 1;
                const workingDays = workingDaysInMonth(year, month);
                const presentDays = calculateAttendanceDays(emp.id, calcMonth);
                const dailyRate = calculateDailyRate(emp.monthly, year, month);
                const finalSalary = presentDays * dailyRate;

                tbody.innerHTML += `
                    <tr class="hover:bg-white transition">
                        <td class="p-3 font-bold">${emp.name}</td>
                        <td class="p-3">${emp.monthly} ج.م</td>
                        <td class="p-3">${workingDays} يوم</td>
                        <td class="p-3 font-bold text-blue-600">${presentDays} أيام</td>
                        <td class="p-3">${dailyRate.toFixed(2)} ج.م</td>
                        <td class="p-3 font-bold text-emerald-600 text-lg">${finalSalary.toFixed(2)} ج.م</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>

